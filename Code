const SPREADSHEET_URL = 'https://docs.google.com/spreadsheets/d/1VqbRAy_ekXDDCV_G1FRzMv3tV4z0WVgY1NPBkao2AHY/edit?usp=sharing';

const SHEET_NAME_COMPANY_INFO = 'ì—…ì²´ì •ë³´';
const SHEET_NAME_MAIL_CONTENT = 'ë©”ì¼ë‚´ìš©';
const SHEET_NAME_LOG = 'ë°œì†¡ê¸°ë¡';
const SHEET_NAME_DRAFTS = 'ì„ì‹œì €ì¥';
const SHEET_NAME_GROUPS = 'ê·¸ë£¹ê´€ë¦¬';
const SHEET_NAME_LOCATIONS = 'ì…ê³ ì§€';

function doGet() {
  return HtmlService.createHtmlOutputFromFile('index')
    .addMetaTag('viewport', 'width=device-width, initial-scale=1')
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}

function getInitialData() {
  const spreadsheet = SpreadsheetApp.openByUrl(SPREADSHEET_URL);
  const companyInfoSheet = spreadsheet.getSheetByName(SHEET_NAME_COMPANY_INFO);
  const mailContentSheet = spreadsheet.getSheetByName(SHEET_NAME_MAIL_CONTENT);
  const groupSheet = spreadsheet.getSheetByName(SHEET_NAME_GROUPS);
  const locationSheet = spreadsheet.getSheetByName(SHEET_NAME_LOCATIONS);

  if (!companyInfoSheet || !mailContentSheet || !groupSheet) {
    throw new Error('ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì‹œíŠ¸ ì´ë¦„ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.');
  }

  // ì—…ì²´ì •ë³´ ë¡œë“œ
  const companyData = companyInfoSheet.getDataRange().getValues();
  const companyHeader = companyData[0];

  const nameIdx = companyHeader.indexOf('ê±°ë˜ì²˜ëª…');
  const brandIdx = companyHeader.indexOf('ë¸Œëœë“œëª…');
  const emailIdx = companyHeader.indexOf('ë©”ì¼ì£¼ì†Œ');
  const ccIdx = companyHeader.indexOf('ì°¸ì¡°');

  const companyMap = {};
  const companyNames = [];
  
  for (let i = 1; i < companyData.length; i++) {
    const name = companyData[i][nameIdx];
    if (!name) continue;

    const rawBrands = brandIdx !== -1 ? (companyData[i][brandIdx] || '') : '';
    const brands = String(rawBrands)
      .split(',')
      .map(s => s.trim())
      .filter(Boolean);

    companyMap[name] = {
      email: companyData[i][emailIdx] || '',
      cc: companyData[i][ccIdx] || '',
      brands,
    };
    companyNames.push(name);
  }

  // ë©”ì¼ í…œí”Œë¦¿
  const mailContents = mailContentSheet.getDataRange().getValues();
  const mailHeader = mailContents[0];
  const mailTemplates = {};
  const mailTypeIdx = mailHeader.indexOf('ë©”ì¼ì¢…ë¥˜');
  const subjectIdx = mailHeader.indexOf('ì œëª©');
  const bodyIdx = mailHeader.indexOf('ë³¸ë¬¸');
  const signatureIdx = mailHeader.indexOf('ì„œëª…');
  
  if (mailTypeIdx === -1) {
    throw new Error('ìŠ¤í”„ë ˆë“œì‹œíŠ¸ "ë©”ì¼ë‚´ìš©" ì‹œíŠ¸ì˜ í—¤ë”(ë©”ì¼ì¢…ë¥˜)ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
  }
  
  for (let i = 1; i < mailContents.length; i++) {
    const type = mailContents[i][mailTypeIdx];
    if (!type) continue;
    mailTemplates[type] = {
      subject: mailContents[i][subjectIdx] || '',
      body: mailContents[i][bodyIdx] || '',
      signature: mailContents[i][signatureIdx] || '',
    };
  }

  // ê·¸ë£¹
  const groupData = groupSheet.getDataRange().getValues();
  const groupHeader = groupData[0];
  const groups = {};
  const groupNameIdx = groupHeader.indexOf('ê·¸ë£¹ëª…');
  const includedCompaniesIdx = groupHeader.indexOf('í¬í•¨ëœ ì—…ì²´ëª…');
  
  for (let i = 1; i < groupData.length; i++) {
    const groupName = groupData[i][groupNameIdx];
    const included = groupData[i][includedCompaniesIdx];
    if (!groupName || !included) continue;
    groups[groupName] = String(included).split(',').map(s => s.trim());
  }

  const companyBrands = {};
  Object.keys(companyMap).forEach(name => {
    companyBrands[name] = companyMap[name].brands || [];
  });

  // âœ… ê°„ë‹¨í•œ ì…ê³ ì§€ ì •ë³´ ë¡œë“œ (ê±°ë˜ì²˜ëª… â†’ ì…ê³ ì§€ì „ì²´ì •ë³´)
  const locationMap = {};
  const locationData = locationSheet.getDataRange().getValues();
  
  if (locationData.length > 1) {
    const nameIdx = locationData[0].indexOf('ê±°ë˜ì²˜ëª…');
    const detailIdx = locationData[0].indexOf('ì…ê³ ì§€ì „ì²´ì •ë³´');
    
    if (nameIdx > -1 && detailIdx > -1) {
      for (let i = 1; i < locationData.length; i++) {
        const companyName = locationData[i][nameIdx];
        const detail = locationData[i][detailIdx];
        
        if (companyName && detail) {
          locationMap[companyName] = detail;
        }
      }
    }
  }

  return {
    companyData: companyMap,
    companyNames,
    companyBrands,
    mailTemplates,
    groups,
    locationData: locationMap
  };
}

function saveMailTemplate(templateData) {
  const spreadsheet = SpreadsheetApp.openByUrl(SPREADSHEET_URL);
  const sheet = spreadsheet.getSheetByName(SHEET_NAME_MAIL_CONTENT);
  const data = sheet.getDataRange().getValues();
  const header = data[0];
  const mailTypeIdx = header.indexOf('ë©”ì¼ì¢…ë¥˜');
  const subjectIdx = header.indexOf('ì œëª©');
  const bodyIdx = header.indexOf('ë³¸ë¬¸');
  const signatureIdx = header.indexOf('ì„œëª…');

  let rowToUpdate = -1;
  for (let i = 1; i < data.length; i++) {
    if (data[i][mailTypeIdx] === templateData.name) {
      rowToUpdate = i + 1;
      break;
    }
  }

  const newRow = [
    templateData.name,
    templateData.subject,
    templateData.body,
    templateData.signature || ''
  ];

  if (rowToUpdate !== -1) {
    sheet.getRange(rowToUpdate, 1, 1, newRow.length).setValues([newRow]);
  } else {
    sheet.appendRow(newRow);
  }
}

function deleteMailTemplate(templateName) {
  const spreadsheet = SpreadsheetApp.openByUrl(SPREADSHEET_URL);
  const sheet = spreadsheet.getSheetByName(SHEET_NAME_MAIL_CONTENT);
  const data = sheet.getDataRange().getValues();
  const header = data[0];
  const mailTypeIdx = header.indexOf('ë©”ì¼ì¢…ë¥˜');

  let rowToDelete = -1;
  for (let i = 1; i < data.length; i++) {
    if (data[i][mailTypeIdx] === templateName) {
      rowToDelete = i + 1;
      break;
    }
  }

  if (rowToDelete !== -1) {
    sheet.deleteRow(rowToDelete);
  }
}

function saveGroup(groupName, companies) {
  const spreadsheet = SpreadsheetApp.openByUrl(SPREADSHEET_URL);
  const sheet = spreadsheet.getSheetByName(SHEET_NAME_GROUPS);
  const data = sheet.getDataRange().getValues();
  const header = data[0];
  const groupNameIdx = header.indexOf('ê·¸ë£¹ëª…');
  const includedCompaniesIdx = header.indexOf('í¬í•¨ëœ ì—…ì²´ëª…');

  let rowToUpdate = -1;
  for (let i = 1; i < data.length; i++) {
    if (data[i][groupNameIdx] === groupName) {
      rowToUpdate = i + 1;
      break;
    }
  }

  const newRow = [groupName, companies.join(', ')];

  if (rowToUpdate !== -1) {
    sheet.getRange(rowToUpdate, 1, 1, newRow.length).setValues([newRow]);
  } else {
    sheet.appendRow(newRow);
  }
}

function deleteGroup(groupName) {
  const spreadsheet = SpreadsheetApp.openByUrl(SPREADSHEET_URL);
  const sheet = spreadsheet.getSheetByName(SHEET_NAME_GROUPS);
  const data = sheet.getDataRange().getValues();
  const header = data[0];
  const groupNameIdx = header.indexOf('ê·¸ë£¹ëª…');

  let rowToDelete = -1;
  for (let i = 1; i < data.length; i++) {
    if (data[i][groupNameIdx] === groupName) {
      rowToDelete = i + 1;
      break;
    }
  }

  if (rowToDelete !== -1) {
    sheet.deleteRow(rowToDelete);
  }
}

function getTodaySentCount() {
  const spreadsheet = SpreadsheetApp.openByUrl(SPREADSHEET_URL);
  const logSheet = spreadsheet.getSheetByName(SHEET_NAME_LOG);
  
  if (!logSheet || logSheet.getLastRow() < 2) {
    return 0;
  }

  const data = logSheet.getDataRange().getValues();
  const today = new Date();
  today.setHours(0, 0, 0, 0);

  let count = 0;
  for (let i = 1; i < data.length; i++) {
    const timestamp = data[i][0];
    if (timestamp instanceof Date) {
      const logDate = new Date(timestamp);
      logDate.setHours(0, 0, 0, 0);
      if (logDate.getTime() === today.getTime()) {
        count++;
      }
    }
  }

  return count;
}

function saveDraft(draftData) {
  const spreadsheet = SpreadsheetApp.openByUrl(SPREADSHEET_URL);
  const sheet = spreadsheet.getSheetByName(SHEET_NAME_DRAFTS);
  if (!sheet) return;
  sheet.clearContents();
  const now = new Date();
  sheet.appendRow(['ì €ì¥ì¼ì‹œ', 'ì œëª©', 'ë³¸ë¬¸', 'ì„œëª…']);
  sheet.appendRow([now, draftData.subject, draftData.body, draftData.signature]);
}

function getLatestDraft() {
  const spreadsheet = SpreadsheetApp.openByUrl(SPREADSHEET_URL);
  const sheet = spreadsheet.getSheetByName(SHEET_NAME_DRAFTS);
  if (!sheet || sheet.getLastRow() < 2) return null;
  const lastRow = sheet.getLastRow();
  const range = sheet.getRange(lastRow, 2, 1, 3);
  const values = range.getValues()[0];
  return { subject: values[0], body: values[1], signature: values[2] };
}

function clearDrafts() {
  const spreadsheet = SpreadsheetApp.openByUrl(SPREADSHEET_URL);
  const sheet = spreadsheet.getSheetByName(SHEET_NAME_DRAFTS);
  if (!sheet) return;
  const lastRow = sheet.getLastRow();
  if (lastRow > 1) {
    sheet.getRange(2, 1, lastRow - 1, sheet.getLastColumn()).clearContent();
  }
}

function sendSingleMail(mailData, recipientData) {
  const spreadsheet = SpreadsheetApp.openByUrl(SPREADSHEET_URL);
  const logSheet = spreadsheet.getSheetByName(SHEET_NAME_LOG);
  if (!logSheet) throw new Error('ë°œì†¡ ê¸°ë¡ ì‹œíŠ¸(ë°œì†¡ê¸°ë¡)ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');

  const now = new Date();
  let status = 'success';
  let message = 'ë°œì†¡ ì„±ê³µ';

  // -------------------------------------------------------------
  // ê³µí†µ: í…œí”Œë¦¿ ì¹˜í™˜ + HTML êµ¬ì„± + ì²¨ë¶€íŒŒì¼ ì²˜ë¦¬ (ê¸°ì¡´ ê·¸ëŒ€ë¡œ)
  // -------------------------------------------------------------
  try {
    if (!recipientData.to || recipientData.to.trim() === '') {
      throw new Error('ìˆ˜ì‹  ì´ë©”ì¼ ì£¼ì†Œê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
    }

    const initialData = getInitialData();
    const companyInfo = initialData.companyData[recipientData.name] || {};
    const brandNames = (companyInfo.brands || []).join(', ');

    const locationMap = initialData.locationData;
    const selectedLocationKeys = mailData.selectedLocationKeys || [];

    const allLocationDetails = selectedLocationKeys
      .map((key, idx) => {
        const detail = locationMap[key] || '';
        if (!detail) return '';
        if (selectedLocationKeys.length > 1) {
          return 'ì…ê³ ì§€' + (idx + 1) + '.\n' + detail;
        }
        return detail;
      })
      .filter(v => v)
      .join('\n\n');

    const variables = {
      '{{ì—…ì²´ëª…}}': recipientData.name,
      '{{ê±°ë˜ì²˜ëª…}}': recipientData.name,
      '{{ë¸Œëœë“œëª…}}': brandNames,
      '{{ì´ë©”ì¼}}': recipientData.to,
      '{{ì°¸ì¡°}}': recipientData.cc || '',
      '{{ë°œì†¡ì¼}}': Utilities.formatDate(now, Session.getScriptTimeZone(), 'yyyy-MM-dd'),
      '{{ë‹´ë‹¹ìëª…}}': '',
      '{{ì…ê³ ì§€}}': allLocationDetails
    };

    selectedLocationKeys.forEach(locKey => {
      variables['{{' + locKey + '}}'] = locKey;
    });

    let mailSubject = mailData.subject;
    let mailBody = mailData.body;
    let mailSignature = mailData.signature || '';

    Object.keys(variables).forEach(key => {
      let value = variables[key];
      if (typeof value === 'string') value = value.replace(/\n/g, '<br>');

      const regex = new RegExp(key.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
      mailSubject = mailSubject.replace(regex, value);
      mailBody = mailBody.replace(regex, value);
      mailSignature = mailSignature.replace(regex, value);
    });

    const allLocationKeys = Object.keys(locationMap);
    allLocationKeys.forEach(locKey => {
      if (!selectedLocationKeys.includes(locKey)) {
        const regex = new RegExp('\\{\\{' + locKey.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\}\\}', 'g');
        mailSubject = mailSubject.replace(regex, '');
        mailBody = mailBody.replace(regex, '');
        mailSignature = mailSignature.replace(regex, '');
      }
    });

    mailBody = mailBody.replace(/\n/g, '<br>');
    if (mailSignature) {
      mailSignature = mailSignature.replace(/\n/g, '<br>');
      mailBody += '<br><br>' + mailSignature;
    }

    mailBody =
      '<!DOCTYPE html><html><head><meta charset="UTF-8">' +
      '<style>body{margin:0;padding:20px;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Arial,Verdana,sans-serif;font-size:14px;line-height:1.6;color:#333;}</style>' +
      '</head><body>' +
      mailBody +
      '</body></html>';

    const finalAttachments = [];

    if (mailData.driveAttachments && mailData.driveAttachments.length > 0) {
      mailData.driveAttachments.forEach(fileData => {
        if (!fileData.mappedRecipients || fileData.mappedRecipients.includes(recipientData.name)) {
          try {
            const driveFile = DriveApp.getFileById(fileData.id);
            const fileName = fileData.name || driveFile.getName();
            finalAttachments.push(driveFile.getBlob().setName(fileName));
          } catch (e) {
            Logger.log('Drive íŒŒì¼ ì²˜ë¦¬ ì˜¤ë¥˜: ' + e.message);
          }
        }
      });
    }

    if (mailData.commonAttachments && mailData.commonAttachments.length > 0) {
      mailData.commonAttachments.forEach(fileData => {
        try {
          const decoded = Utilities.base64Decode(fileData.data);
          const blob = Utilities.newBlob(decoded, fileData.mimeType, fileData.fileName);
          blob.setContentType(fileData.mimeType);
          finalAttachments.push(blob);
        } catch (e) {
          Logger.log('ê³µí†µ ì²¨ë¶€ ì˜¤ë¥˜: ' + e.message);
        }
      });
    }

    if (mailData.attachments && mailData.attachments.length > 0) {
      mailData.attachments.forEach(fileData => {
        if (fileData.mappedRecipients && fileData.mappedRecipients.includes(recipientData.name)) {
          try {
            const decoded = Utilities.base64Decode(fileData.data);
            const blob = Utilities.newBlob(decoded, fileData.mimeType, fileData.fileName);
            blob.setContentType(fileData.mimeType);
            finalAttachments.push(blob);
          } catch (e) {
            Logger.log('ê°œë³„ ì²¨ë¶€ ì˜¤ë¥˜: ' + e.message);
          }
        }
      });
    }

    // -------------------------------------------------------------
    // ğŸŸ¦ 1ì°¨: ê¸°ì¡´ ë°©ì‹ìœ¼ë¡œ ìë™ ë°œì†¡ (sendEmail)
    // -------------------------------------------------------------
    const options = {
      htmlBody: mailBody,
      cc: recipientData.cc || undefined,
      attachments: finalAttachments.length > 0 ? finalAttachments : undefined,
      name: 'ë¯¸ë¯¸ë¼ì¸'
    };

    GmailApp.sendEmail(recipientData.to, mailSubject, '', options);

  } catch (err) {
    // -------------------------------------------------------------
    // ğŸŸ¥ 1ì°¨ ì‹¤íŒ¨ â†’ ì¦‰ì‹œ Gmail Draft fallback ì‹¤í–‰
    // -------------------------------------------------------------
    status = 'failed_draft';
    message = 'ìë™ ë°œì†¡ ì‹¤íŒ¨ â†’ Draft ìƒì„± ì™„ë£Œ: ' + err.message;

    try {
      GmailApp.createDraft(recipientData.to, mailData.subject, '', {
        htmlBody: mailBody,
        cc: recipientData.cc || undefined,
        attachments: finalAttachments.length > 0 ? finalAttachments : undefined,
        name: 'ë¯¸ë¯¸ë¼ì¸'
      });
    } catch (draftErr) {
      status = 'failed';
      message = 'Draft ìƒì„±ë„ ì‹¤íŒ¨: ' + draftErr.message;
      Logger.log('Draft ìƒì„± ì˜¤ë¥˜: ' + draftErr.message);
    }
  }

  // -------------------------------------------------------------
  // ë¡œê·¸ ê¸°ë¡
  // -------------------------------------------------------------
  logSheet.appendRow([
    now,
    mailData.mailType,
    recipientData.name,
    recipientData.to,
    status,
    message
  ]);

  return {
    recipient: recipientData.name,
    to: recipientData.to,
    status: status,
    message: message
  };
}

function getBrandNames(companyName) {
  const data = getInitialData();
  const company = data.companyData[companyName];
  if (company && company.brands && company.brands.length > 0) {
    return company.brands.join(', ');
  }
  return '';
}

function getContactName(companyName) {
  return '';
}

function getOAuthToken() {
  return ScriptApp.getOAuthToken();
}
