<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>발송 진행 상황</title>
  <style>
    body{font-family:system-ui,arial,sans-serif;margin:0;padding:16px}
    h2{margin:0 0 12px}
    .bar{height:22px;background:#e5e5ea;border-radius:12px;overflow:hidden}
    .fill{height:100%;width:0%;background:#007aff;color:#fff;text-align:center;line-height:22px;transition:width .2s}
    #log{border:1px solid #eee;border-radius:8px;height:260px;overflow:auto;padding:8px;margin-top:12px;font-size:14px;background:#fafafa}
    .row{display:flex;gap:8px;align-items:center;margin:8px 0}
    button{background:#007aff;color:#fff;border:none;border-radius:8px;padding:8px 12px;cursor:pointer}
    .secondary{background:#8e8e93}
    .ok{color:#0a8a0a} .fail{color:#c62828}
  </style>
  <script>
    let total=0, current=0, ok=0, fail=0;

    function setText(id, v){ document.getElementById(id).textContent = v; }
    function appendLog(msg, cls){
      const p = document.createElement('p');
      p.textContent = msg; if(cls) p.className = cls;
      document.getElementById('log').appendChild(p);
      document.getElementById('log').scrollTop = 99999;
    }
    function setProgress(n){
      const el = document.getElementById('fill');
      el.style.width = Math.max(0, Math.min(100, n)) + '%';
      el.textContent = Math.round(n) + '%';
    }

    function handleMessage(ev){
      const d = ev.data || {};
      switch(d.type){
        case 'progress:init':
          total = d.total||0; current=0; ok=0; fail=0;
          setText('total', total); setText('current', current);
          setText('ok', ok); setText('fail', fail); setProgress(0);
          document.getElementById('closeBtn').disabled = false; // 항상 닫기 가능
          appendLog('발송을 시작합니다…');
          break;
        case 'progress:update':
          current = d.current||current;
          if(d.status==='success') ok++; else if(d.status==='failed') fail++;
          setText('current', current); setText('ok', ok); setText('fail', fail);
          setProgress(total? (current/total*100) : 0);
          appendLog(`${d.name} (${d.email}) — ${d.status==='success'?'성공':'실패'}`, d.status==='success'?'ok':'fail');
          break;
        case 'progress:error':
          appendLog('오류: '+(d.message||'알 수 없는 오류'), 'fail');
          break;
        case 'progress:done':
          appendLog('발송이 완료되었습니다.');
          setProgress(100);
          break;
      }
    }

    window.addEventListener('message', handleMessage);
  </script>
</head>
<body>
  <h2>메일 발송 진행 상황</h2>
  <div class="row">
    <div>총 <b id="total">0</b>건 중 <b id="current">0</b>건 처리</div>
    <div>성공: <b id="ok">0</b>, 실패: <b id="fail">0</b></div>
  </div>
  <div class="bar"><div id="fill" class="fill">0%</div></div>
  <div id="log"></div>
  <div class="row" style="justify-content:flex-end">
    <button class="secondary" id="closeBtn" onclick="window.close()">닫기</button>
  </div>
</body>
</html>
