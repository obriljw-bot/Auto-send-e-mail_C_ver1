<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ë©”ì¼ ë°œì†¡ ì‹œìŠ¤í…œ</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --primary: #6B7280;
      --secondary: #4B5563;
      --success: #10B981;
      --warning: #F59E0B;
      --danger: #EF4444;
      --bg-primary: #F9FAFB;
      --bg-secondary: #F3F4F6;
      --text-primary: #111827;
      --text-secondary: #6B7280;
      --border: #E5E7EB;
      --shadow: rgba(0, 0, 0, 0.05);
      --radius: 12px;
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg-primary: #1F2937;
        --bg-secondary: #111827;
        --text-primary: #F9FAFB;
        --text-secondary: #9CA3AF;
        --border: #374151;
        --shadow: rgba(0, 0, 0, 0.3);
      }
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-secondary);
      color: var(--text-primary);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
    }

    header {
      background: rgba(249, 250, 251, 0.8);
      backdrop-filter: saturate(180%) blur(20px);
      border-bottom: 1px solid var(--border);
      padding: 16px 24px;
      position: sticky;
      top: 0;
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    @media (prefers-color-scheme: dark) {
      header { background: rgba(31, 41, 55, 0.8); }
    }

    .header-left { display: flex; align-items: center; gap: 12px; }
    .header-icon { font-size: 24px; }
    .header-title { font-size: 20px; font-weight: 600; letter-spacing: -0.5px; }

    .quota-info {
      font-size: 13px;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .quota-badge {
      background: var(--bg-secondary);
      padding: 4px 10px;
      border-radius: 12px;
      font-weight: 500;
    }

    main {
      max-width: 1400px;
      margin: 32px auto;
      padding: 0 24px;
      display: grid;
      grid-template-columns: 60% 30% 1fr;
      gap: 20px;
      align-items: start;
    }

    .column-left, .column-right, .column-extra {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .card {
      background: var(--bg-primary);
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: 0 2px 8px var(--shadow);
      border: 1px solid var(--border);
      transition: var(--transition);
    }

    .card:hover {
      box-shadow: 0 4px 16px var(--shadow);
      transform: translateY(-2px);
    }

    .card-title {
      font-size: 17px;
      font-weight: 600;
      margin-bottom: 16px;
      color: var(--text-primary);
      letter-spacing: -0.3px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    input[type="text"], input[type="number"], textarea, select {
      width: 100%;
      padding: 12px 16px;
      font-size: 15px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--bg-primary);
      color: var(--text-primary);
      transition: var(--transition);
      font-family: inherit;
    }

    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(107, 114, 128, 0.1);
    }

    textarea { min-height: 336px; resize: vertical; }

    button {
      font-family: inherit;
      font-size: 15px;
      font-weight: 500;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      gap: 8px;
      letter-spacing: -0.2px;
    }

    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--secondary); transform: scale(1.02); }
    .btn-primary:active { transform: scale(0.98); }

    .btn-secondary {
      background: var(--bg-secondary);
      color: var(--text-primary);
      border: 1px solid var(--border);
    }
    .btn-secondary:hover { background: var(--border); }

    .btn-danger { background: var(--danger); color: white; }
    .btn-danger:hover { background: #dc2626; }

    .btn-icon {
      width: 36px;
      height: 36px;
      padding: 0;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      color: var(--text-secondary);
    }
    .btn-icon:hover { background: var(--bg-secondary); color: var(--text-primary); }

    .btn-compact { padding: 6px 12px; font-size: 13px; }

    .recipient-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 12px;
    }

    .recipient-tag {
      background: rgba(107, 114, 128, 0.1);
      color: var(--primary);
      padding: 6px 12px;
      border-radius: 16px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .recipient-tag:hover { background: rgba(107, 114, 128, 0.2); transform: scale(1.05); }

    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(10px);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.2s ease;
    }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    .modal-content {
      background: var(--bg-primary);
      border-radius: 16px;
      width: 90%;
      max-width: 800px;
      max-height: 85vh;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      flex-direction: column;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }

    .modal-title { font-size: 18px; font-weight: 600; letter-spacing: -0.3px; }

    .modal-body { padding: 24px; overflow-y: auto; flex: 1; }

    .close {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--text-secondary);
      font-size: 24px;
      transition: var(--transition);
    }
    .close:hover { background: var(--bg-secondary); color: var(--text-primary); }

    /* ì»¤ìŠ¤í…€ ì•Œë¦¼ ëª¨ë‹¬ */
    .alert-modal {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(10px);
      z-index: 2000;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.2s ease;
    }

    .alert-modal.show { display: flex; }

    .alert-content {
      background: var(--bg-primary);
      border-radius: 16px;
      width: 90%;
      max-width: 480px;
      max-height: 80vh;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      flex-direction: column;
    }

    .alert-header {
      padding: 20px 24px 0 24px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .alert-icon {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      flex-shrink: 0;
    }

    .alert-icon.info { background: rgba(59, 130, 246, 0.1); color: #3B82F6; }
    .alert-icon.success { background: rgba(16, 185, 129, 0.1); color: #10B981; }
    .alert-icon.warning { background: rgba(245, 158, 11, 0.1); color: #F59E0B; }
    .alert-icon.error { background: rgba(239, 68, 68, 0.1); color: #EF4444; }

    .alert-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
      letter-spacing: -0.3px;
    }

    .alert-body {
      padding: 16px 24px 24px 24px;
      overflow-y: auto;
      flex: 1;
    }

    .alert-message {
      font-size: 14px;
      color: var(--text-secondary);
      line-height: 1.7;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .alert-footer {
      padding: 16px 24px 20px 24px;
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      border-top: 1px solid var(--border);
    }

    .alert-btn {
      padding: 10px 24px;
      font-size: 14px;
      font-weight: 500;
      border-radius: 8px;
      cursor: pointer;
      transition: var(--transition);
      border: none;
    }

    .alert-btn.primary {
      background: var(--primary);
      color: white;
    }

    .alert-btn.primary:hover {
      background: var(--secondary);
    }

    .alert-btn.secondary {
      background: var(--bg-secondary);
      color: var(--text-primary);
      border: 1px solid var(--border);
    }

    .alert-btn.secondary:hover {
      background: var(--border);
    }

    .tabs { display: flex; gap: 4px; margin-bottom: 20px; border-bottom: 1px solid var(--border); }

    .tab {
      padding: 10px 20px;
      cursor: pointer;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      border-bottom: 2px solid transparent;
      transition: var(--transition);
    }
    .tab.active { color: var(--primary); border-bottom-color: var(--primary); }

    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .file-list {
      margin-top: 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .file-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      background: var(--bg-secondary);
      border-radius: 8px;
      font-size: 14px;
    }

    .file-item-left { display: flex; align-items: center; gap: 10px; flex: 1; min-width: 0; }

    .file-item-name {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .file-badge {
      background: var(--primary);
      color: white;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
    }

    .checkbox-wrapper {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: var(--transition);
    }
    .checkbox-wrapper:hover { background: var(--bg-secondary); }

    input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
      accent-color: var(--primary);
    }

    .stats-grid { display: grid; gap: 8px; }

    .stat-card {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      padding: 8px 12px;
      border-radius: 8px;
      text-align: center;
      min-width: 70px;
    }

    .stat-value { font-size: 16px; font-weight: 700; margin-bottom: 2px; }
    .stat-label { font-size: 11px; opacity: 0.9; }

    .form-group { margin-bottom: 16px; }
    .form-group label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 8px;
      color: var(--text-primary);
    }

    .progress-log {
      height: 200px;
      overflow-y: auto;
      background: var(--bg-secondary);
      padding: 12px;
      border-radius: 8px;
      font-size: 13px;
      font-family: 'Courier New', monospace;
    }

    .log-line { margin-bottom: 4px; padding: 4px; border-radius: 4px; }
    .log-success { color: var(--success); }
    .log-failed { color: var(--danger); }
    .log-info { color: var(--text-secondary); }

    .template-list { display: flex; flex-direction: column; gap: 8px; }

    .template-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px;
      background: var(--bg-secondary);
      border-radius: 8px;
      cursor: pointer;
      transition: var(--transition);
    }
    .template-item:hover { background: var(--border); }

    .template-item-actions { display: flex; gap: 8px; }

    .preview-container {
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 20px;
      background: white;
      color: #000;
      min-height: 300px;
    }

    .preview-subject {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 2px solid var(--border);
    }

    .preview-body { line-height: 1.8; white-space: pre-wrap; }

    .variable-hint {
      background: rgba(107, 114, 128, 0.1);
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 13px;
      color: var(--text-secondary);
      margin-top: 8px;
    }

    .location-badge {
      display: inline-block;
      background: rgba(16, 185, 129, 0.1);
      color: var(--success);
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
      margin-left: 8px;
    }

    .group-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 10px 12px;
      background: var(--bg-secondary);
      border-radius: 8px;
      margin-bottom: 8px;
      flex-direction: column;
    }

    .group-item-header { display: flex; align-items: center; gap: 12px; width: 100%; }
    .group-item-name { flex: 1; font-weight: 500; }
    .group-item-count { font-size: 12px; color: var(--text-secondary); }
    .group-item-companies {
      font-size: 13px;
      color: var(--text-secondary);
      padding-left: 32px;
      line-height: 1.6;
    }

    @media (max-width: 1200px) {
      main { grid-template-columns: 1fr; padding: 0 16px; margin: 16px auto; }
      .card { padding: 16px; }
      .modal-content { width: 95%; }
    }

    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: var(--bg-secondary); }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--text-secondary); }
  </style>
</head>
<body>
  <header>
    <div class="header-left">
      <span class="header-icon">âœ‰ï¸</span>
      <h1 class="header-title">ë©”ì¼ ë°œì†¡ ì‹œìŠ¤í…œ</h1>
    </div>
    <div class="quota-info">
      <span>ì˜¤ëŠ˜ ë°œì†¡:</span>
      <span class="quota-badge" id="todaySent">0</span>
      <span>|</span>
      <span>ì”ì—¬:</span>
      <span class="quota-badge" id="quotaRemaining">-</span>
    </div>
  </header>

  <main>
    <div class="column-left">
      <div class="card">
        <div class="card-title">
          <span>í…œí”Œë¦¿ ì„ íƒ</span>
          <button class="btn-secondary btn-compact" id="manageTemplatesBtn">í…œí”Œë¦¿ ê´€ë¦¬</button>
        </div>
        <select id="templateSelect">
          <option value="">í…œí”Œë¦¿ì„ ì„ íƒí•˜ì„¸ìš”</option>
        </select>
      </div>

      <div class="card">
        <h2 class="card-title">ìˆ˜ì‹ ì ê´€ë¦¬</h2>
        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
          <button class="btn-secondary" id="openRecipientModal">ìˆ˜ì‹ ì ì„ íƒ</button>
          <button class="btn-secondary" id="openGroupModal">ê·¸ë£¹ ì„ íƒ</button>
        </div>
        <div class="recipient-tags" id="selectedRecipientsDisplay"></div>
      </div>

      <div class="card">
        <div class="card-title">
          <span>ë©”ì¼ ë‚´ìš©</span>
          <button class="btn-primary btn-compact" id="previewMailBtn">ğŸ‘ï¸ ë¯¸ë¦¬ë³´ê¸°</button>
        </div>
        <div class="form-group">
          <label>ì œëª©</label>
          <input type="text" id="mailSubject" placeholder="ë©”ì¼ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
          <div class="variable-hint">
            ğŸ’¡ ì‚¬ìš© ê°€ëŠ¥í•œ ë³€ìˆ˜: {{ì—…ì²´ëª…}}, {{ë¸Œëœë“œëª…}}, {{ì´ë©”ì¼}}, {{ì°¸ì¡°}}, {{ë°œì†¡ì¼}}, {{ë‹´ë‹¹ìëª…}}, {{ì…ê³ ì§€}}
          </div>
        </div>
        <div class="form-group">
          <label>ë³¸ë¬¸</label>
          <textarea id="mailBody" placeholder="ë©”ì¼ ë³¸ë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”&#10;&#10;ì‚¬ìš© ê°€ëŠ¥í•œ ë³€ìˆ˜:&#10;{{ì—…ì²´ëª…}}, {{ê±°ë˜ì²˜ëª…}}, {{ë¸Œëœë“œëª…}}, {{ì´ë©”ì¼}}, {{ì°¸ì¡°}}, {{ë°œì†¡ì¼}}, {{ë‹´ë‹¹ìëª…}}, {{ì…ê³ ì§€}}"></textarea>
        </div>
        <div class="form-group">
          <label>ì„œëª…</label>
          <textarea id="mailSignature" placeholder="ë©”ì¼ ì„œëª…ì„ ì…ë ¥í•˜ì„¸ìš”" style="min-height: 100px;"></textarea>
        </div>
      </div>
    </div>

    <div class="column-right">
      <div class="card">
        <h2 class="card-title">ë°œì†¡ ì„¤ì •</h2>
        <div class="form-group">
          <label>ë°œì†¡ ê°„ê²© (ì´ˆ)</label>
          <input type="number" id="sendInterval" value="2" min="1">
          <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
            ê¶Œì¥: 2ì´ˆ ì´ìƒ
          </div>
        </div>
        <button class="btn-primary" id="sendMailBtn" style="width: 100%;">
          <span>ë°œì†¡ ì‹œì‘</span>
          <span>â†’</span>
        </button>
      </div>

      <div class="card">
        <h2 class="card-title">ë°œì†¡ í˜„í™©</h2>
        <div class="stats-grid" style="grid-template-columns: repeat(3, 1fr);">
          <div class="stat-card">
            <div class="stat-value" id="statTotal">0</div>
            <div class="stat-label">ì´ë°œì†¡</div>
          </div>
          <div class="stat-card" style="background: linear-gradient(135deg, var(--success), #059669);">
            <div class="stat-value" id="statSuccess">0</div>
            <div class="stat-label">ì„±ê³µ</div>
          </div>
          <div class="stat-card" style="background: linear-gradient(135deg, var(--danger), #dc2626);">
            <div class="stat-value" id="statFailed">0</div>
            <div class="stat-label">ì‹¤íŒ¨</div>
          </div>
        </div>
      </div>

      <div class="card" id="failedMailCard" style="display:none;">
        <div class="card-title">
          <span>ì‹¤íŒ¨ ë©”ì¼ ê´€ë¦¬</span>
          <div style="display:flex;gap:8px;">
            <button class="btn-secondary btn-compact" id="refreshFailedBtn">ìƒˆë¡œê³ ì¹¨</button>
            <button class="btn-primary btn-compact" id="resendAllFailedBtn">ì „ì²´ ì¬ë°œì†¡</button>
          </div>
        </div>
        <div id="failedMailStats" style="margin-bottom:12px;"></div>
        <div class="progress-log" id="failedMailList" style="height:200px;"></div>
      </div>

      <div class="card">
        <h2 class="card-title">íŒŒì¼ ì²¨ë¶€</h2>
        
        <div style="margin-bottom: 16px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <label style="font-size: 14px; font-weight: 500;">ê³µí†µ ì²¨ë¶€íŒŒì¼</label>
            <button class="btn-secondary btn-compact" id="clearCommonFiles">ğŸ—‘ï¸ ì „ì²´ì‚­ì œ</button>
          </div>
          <div style="display: flex; gap: 8px;">
            <label class="btn-secondary btn-compact" for="commonFiles" style="cursor: pointer;">
              ë¡œì»¬ íŒŒì¼
              <input type="file" id="commonFiles" multiple style="display: none;">
            </label>
            <button class="btn-secondary btn-compact" id="addDriveCommon">Drive íŒŒì¼</button>
          </div>
          <div class="file-list" id="commonFileList"></div>
        </div>

        <div>
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <label style="font-size: 14px; font-weight: 500;">ê°œë³„ ì²¨ë¶€íŒŒì¼</label>
            <button class="btn-secondary btn-compact" id="clearIndividualFiles">ğŸ—‘ï¸ ì „ì²´ì‚­ì œ</button>
          </div>
          <div style="display: flex; gap: 8px; flex-wrap: wrap;">
            <label class="btn-secondary btn-compact" for="individualFiles" style="cursor: pointer;">
              ë¡œì»¬ íŒŒì¼
              <input type="file" id="individualFiles" multiple style="display: none;">
            </label>
            <button class="btn-secondary btn-compact" id="addDriveIndividual">Drive íŒŒì¼</button>
            <button class="btn-secondary btn-compact" id="openFileMappingModal">íŒŒì¼ ë§¤í•‘ ê´€ë¦¬</button>
          </div>
          <div class="file-list" id="individualFileList"></div>
        </div>
      </div>
    </div>

    <div class="column-extra"></div>
  </main>

  <!-- ëª¨ë‹¬ë“¤ -->
  <div id="previewModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">ë©”ì¼ ë¯¸ë¦¬ë³´ê¸°</h3>
        <span class="close" data-modal="previewModal">Ã—</span>
      </div>
      <div class="modal-body">
        <div style="margin-bottom: 16px;">
          <label style="font-size: 14px; font-weight: 500; margin-bottom: 8px; display: block;">ë¯¸ë¦¬ë³´ê¸° ëŒ€ìƒ ìˆ˜ì‹ ì</label>
          <select id="previewRecipientSelect" style="margin-bottom: 12px;">
            <option value="">ìˆ˜ì‹ ìë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
          </select>
        </div>
        <div class="preview-container">
          <div class="preview-subject" id="previewSubject"></div>
          <div class="preview-body" id="previewBody"></div>
        </div>
      </div>
    </div>
  </div>

  <div id="recipientModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">ìˆ˜ì‹ ì ì„ íƒ</h3>
        <span class="close" data-modal="recipientModal">Ã—</span>
      </div>
      <div class="modal-body">
        <input type="text" id="recipientSearch" placeholder="ğŸ” ìˆ˜ì‹ ì ê²€ìƒ‰..." style="margin-bottom: 16px;">
        <div id="recipientList"></div>
      </div>
    </div>
  </div>

  <div id="groupModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">ê·¸ë£¹ ê´€ë¦¬</h3>
        <span class="close" data-modal="groupModal">Ã—</span>
      </div>
      <div class="modal-body">
        <div class="tabs">
          <button class="tab active" data-tab="selectGroup">ê·¸ë£¹ ì„ íƒ</button>
          <button class="tab" data-tab="manageGroup">ê·¸ë£¹ ê´€ë¦¬</button>
        </div>
        
        <div id="selectGroup" class="tab-content active">
          <div id="groupList"></div>
        </div>
        
        <div id="manageGroup" class="tab-content">
          <div class="form-group">
            <label>ìƒˆ ê·¸ë£¹ ì´ë¦„</label>
            <input type="text" id="newGroupName" placeholder="ê·¸ë£¹ëª… ì…ë ¥">
          </div>
          <button class="btn-primary" id="createGroupBtn" style="width: 100%; margin-bottom: 20px;">ê·¸ë£¹ ìƒì„±</button>
          <div id="existingGroups"></div>
        </div>
      </div>
    </div>
  </div>

  <div id="templateModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">í…œí”Œë¦¿ ê´€ë¦¬</h3>
        <span class="close" data-modal="templateModal">Ã—</span>
      </div>
      <div class="modal-body">
        <button class="btn-primary" id="addTemplateBtn" style="width: 100%; margin-bottom: 20px;">+ ìƒˆ í…œí”Œë¦¿ ì¶”ê°€</button>
        <div id="templateList" class="template-list"></div>
      </div>
    </div>
  </div>

  <div id="templateEditModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="templateEditTitle">í…œí”Œë¦¿ í¸ì§‘</h3>
        <span class="close" data-modal="templateEditModal">Ã—</span>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>í…œí”Œë¦¿ ì´ë¦„</label>
          <input type="text" id="editTemplateName" placeholder="í…œí”Œë¦¿ ì´ë¦„">
        </div>
        <div class="form-group">
          <label>ì œëª©</label>
          <input type="text" id="editTemplateSubject" placeholder="ë©”ì¼ ì œëª©">
        </div>
        <div class="form-group">
          <label>ë³¸ë¬¸</label>
          <textarea id="editTemplateBody" placeholder="ë©”ì¼ ë³¸ë¬¸" style="min-height: 200px;"></textarea>
        </div>
        <div class="form-group">
          <label>ì„œëª…</label>
          <textarea id="editTemplateSignature" placeholder="ë©”ì¼ ì„œëª…" style="min-height: 100px;"></textarea>
        </div>
        <button class="btn-primary" id="saveTemplateBtn" style="width: 100%;">ì €ì¥</button>
      </div>
    </div>
  </div>

  <div id="fileMappingModal" class="modal">
    <div class="modal-content" style="max-width: 1200px;">
      <div class="modal-header">
        <h3 class="modal-title">íŒŒì¼ ë§¤í•‘ ê´€ë¦¬</h3>
        <span class="close" data-modal="fileMappingModal">Ã—</span>
      </div>
      <div class="modal-body">
        <div id="fileMappingContainer"></div>
      </div>
    </div>
  </div>

  <div id="progressModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">ë°œì†¡ ì§„í–‰ ìƒí™©</h3>
        <span class="close" data-modal="progressModal">Ã—</span>
      </div>
      <div class="modal-body">
        <div id="progressSummary" style="margin-bottom: 16px; font-weight: 500;"></div>
        <div class="progress-log" id="progressLog"></div>
      </div>
    </div>
  </div>

  <div id="recipientEditModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">ìˆ˜ì‹ ì ì •ë³´ ìˆ˜ì •</h3>
        <span class="close" data-modal="recipientEditModal">Ã—</span>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>ì´ë¦„</label>
          <input type="text" id="editRecipientName" disabled>
        </div>
        <div class="form-group">
          <label>ì´ë©”ì¼ (To)</label>
          <input type="text" id="editRecipientTo">
        </div>
        <div class="form-group">
          <label>ì°¸ì¡° (Cc)</label>
          <input type="text" id="editRecipientCc">
        </div>
        <button class="btn-primary" id="saveRecipientEditBtn" style="width: 100%;">ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- ì»¤ìŠ¤í…€ ì•Œë¦¼ ëª¨ë‹¬ -->
  <div id="alertModal" class="alert-modal">
    <div class="alert-content">
      <div class="alert-header">
        <div class="alert-icon" id="alertIcon">!</div>
        <h3 class="alert-title" id="alertTitle">ì•Œë¦¼</h3>
      </div>
      <div class="alert-body">
        <p class="alert-message" id="alertMessage"></p>
      </div>
      <div class="alert-footer">
        <button class="alert-btn secondary" id="alertCancelBtn" style="display: none;">ì·¨ì†Œ</button>
        <button class="alert-btn primary" id="alertOkBtn">í™•ì¸</button>
      </div>
    </div>
  </div>

  <script src="https://apis.google.com/js/api.js"></script>

  <!-- JavaScriptëŠ” Part 2, 3ì—ì„œ ê³„ì† -->

<script>
  let companyNames = [];
  let companyBrands = {};
  let companyData = {};
  let selectedRecipients = [];
  let individualFileMap = [];
  let commonDriveFiles = [];
  let individualDriveFiles = [];
  let editingRecipient = null;
  let mailTemplates = {};
  let groups = {};
  let editingTemplate = null;
  let todaySentCount = 0;
  let pickerApiLoaded = false;
  let oauthToken = '';
  let locationData = {};
  let contactData = {};   // ğŸ†• ë‹´ë‹¹ì
  let phoneData = {};     // ğŸ†• ì—°ë½ì²˜
  let isDataLoaded = false;  // ğŸ†• ì´ˆê¸° ë°ì´í„° ë¡œë”© ì™„ë£Œ ì—¬ë¶€

  let quotaRemainingCount = null;
  let alertResolve = null;

  // ========== ì»¤ìŠ¤í…€ ì•Œë¦¼ ëª¨ë‹¬ ==========
  const alertIcons = {
    info: 'â„¹ï¸',
    success: 'âœ“',
    warning: 'âš ï¸',
    error: 'âœ•'
  };

  const alertTitles = {
    info: 'ì•Œë¦¼',
    success: 'ì„±ê³µ',
    warning: 'ì£¼ì˜',
    error: 'ì˜¤ë¥˜'
  };

  function showAlert(message, type = 'info', title = null) {
    return new Promise((resolve) => {
      alertResolve = resolve;
      const modal = document.getElementById('alertModal');
      const iconEl = document.getElementById('alertIcon');
      const titleEl = document.getElementById('alertTitle');
      const messageEl = document.getElementById('alertMessage');
      const cancelBtn = document.getElementById('alertCancelBtn');
      const okBtn = document.getElementById('alertOkBtn');

      iconEl.className = 'alert-icon ' + type;
      iconEl.textContent = alertIcons[type] || alertIcons.info;
      titleEl.textContent = title || alertTitles[type] || 'ì•Œë¦¼';
      messageEl.textContent = message;

      cancelBtn.style.display = 'none';
      okBtn.textContent = 'í™•ì¸';

      okBtn.onclick = () => {
        modal.classList.remove('show');
        resolve(true);
      };

      modal.classList.add('show');
    });
  }

  function showConfirm(message, type = 'warning', title = null) {
    return new Promise((resolve) => {
      alertResolve = resolve;
      const modal = document.getElementById('alertModal');
      const iconEl = document.getElementById('alertIcon');
      const titleEl = document.getElementById('alertTitle');
      const messageEl = document.getElementById('alertMessage');
      const cancelBtn = document.getElementById('alertCancelBtn');
      const okBtn = document.getElementById('alertOkBtn');

      iconEl.className = 'alert-icon ' + type;
      iconEl.textContent = alertIcons[type] || alertIcons.warning;
      titleEl.textContent = title || alertTitles[type] || 'í™•ì¸';
      messageEl.textContent = message;

      cancelBtn.style.display = 'inline-block';
      okBtn.textContent = 'í™•ì¸';

      cancelBtn.onclick = () => {
        modal.classList.remove('show');
        resolve(false);
      };

      okBtn.onclick = () => {
        modal.classList.remove('show');
        resolve(true);
      };

      modal.classList.add('show');
    });
  }

  // ========== ì´ˆê¸°í™” ==========
  window.addEventListener('DOMContentLoaded', () => {
    google.script.run.withSuccessHandler(initPage).getInitialData();
    google.script.run.withSuccessHandler(token => {
      oauthToken = token;
    }).getOAuthToken();

    document.querySelectorAll('.close').forEach(el => {
      el.addEventListener('click', () => hideModal(el.dataset.modal));
    });

    document.getElementById('openRecipientModal').onclick = () => showModal('recipientModal');
    document.getElementById('openGroupModal').onclick = () => {
      renderGroupList();
      showModal('groupModal');
    };
    document.getElementById('manageTemplatesBtn').onclick = () => {
      renderTemplateList();
      showModal('templateModal');
    };
    document.getElementById('openFileMappingModal').onclick = () => {
      google.script.run
        .withSuccessHandler((data) => {
          companyNames = data.companyNames || [];
          companyBrands = data.companyBrands || {};
          companyData = data.companyData || {};
          renderFileMapping();
          showModal('fileMappingModal');
        })
        .withFailureHandler((error) => {
          showAlert('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + error.message, 'error');
        })
        .getInitialData();
    };

    document.getElementById('previewMailBtn').onclick = showPreviewModal;
    document.getElementById('clearCommonFiles').onclick = clearAllCommonFiles;
    document.getElementById('clearIndividualFiles').onclick = clearAllIndividualFiles;

    document.getElementById('commonFiles').addEventListener('change', handleCommonFilesChange);
    document.getElementById('individualFiles').addEventListener('change', handleIndividualFilesChange);

    document.getElementById('addDriveCommon').onclick = () => pickDriveFiles('common');
    document.getElementById('addDriveIndividual').onclick = () => pickDriveFiles('individual');

    document.getElementById('saveRecipientEditBtn').onclick = saveRecipientEdit;
    document.getElementById('sendMailBtn').onclick = startMailSending;

    document.getElementById('addTemplateBtn').onclick = () => {
      editingTemplate = null;
      document.getElementById('templateEditTitle').textContent = 'ìƒˆ í…œí”Œë¦¿ ì¶”ê°€';
      document.getElementById('editTemplateName').value = '';
      document.getElementById('editTemplateName').disabled = false;
      document.getElementById('editTemplateSubject').value = '';
      document.getElementById('editTemplateBody').value = '';
      document.getElementById('editTemplateSignature').value = '';
      showModal('templateEditModal');
    };

    document.getElementById('saveTemplateBtn').onclick = saveTemplate;
    document.getElementById('createGroupBtn').onclick = createGroup;

    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const target = tab.dataset.tab;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(target).classList.add('active');
      });
    });

    document.getElementById('recipientSearch').addEventListener('input', (e) => {
      renderRecipientList(companyNames, e.target.value);
    });

    document.getElementById('previewRecipientSelect').addEventListener('change', updatePreview);

    document.getElementById('refreshFailedBtn').onclick = loadFailedEmails;
    document.getElementById('resendAllFailedBtn').onclick = resendAllFailed;

    loadPickerApi();
    calculateTodaySent();
    loadQuota();
    loadFailedEmails();
  });

  function initPage(data) {
    companyNames = data.companyNames || [];
    companyBrands = data.companyBrands || {};
    companyData = data.companyData || {};
    mailTemplates = data.mailTemplates || {};
    groups = data.groups || {};
    locationData = data.locationData || {}; // ğŸ†• ì…ê³ ì§€ ë°ì´í„° ì €ì¥
    isDataLoaded = true;  // ğŸ†• ë°ì´í„° ë¡œë”© ì™„ë£Œ í‘œì‹œ

    initTemplateSelect();
    renderRecipientList(companyNames);

    // ğŸ†• ë°ì´í„° ë¡œë”© ì „ì— ì²¨ë¶€ëœ íŒŒì¼ì´ ìˆë‹¤ë©´ ë‹¤ì‹œ ë§¤í•‘
    if (individualFileMap.length > 0) {
      individualFileMap.forEach(item => {
        if (!item.recipients || item.recipients.length === 0) {
          item.recipients = autoMapFile(item.fileName || item.name || '');
          item.mappingDetails = autoMapFileDetails(item.fileName || item.name || '');
        }
      });
      syncSelectedRecipientsToMapping();
    }
  }

  function initTemplateSelect() {
    const sel = document.getElementById('templateSelect');
    sel.innerHTML = '<option value="">í…œí”Œë¦¿ì„ ì„ íƒí•˜ì„¸ìš”</option>';
    Object.keys(mailTemplates).forEach(name => {
      const opt = document.createElement('option');
      opt.value = name;
      opt.textContent = name;
      sel.appendChild(opt);
    });
    sel.onchange = () => {
      const t = mailTemplates[sel.value];
      if (t) {
        document.getElementById('mailSubject').value = t.subject || '';
        document.getElementById('mailBody').value = t.body || '';
        document.getElementById('mailSignature').value = t.signature || '';
      }
    };
  }

  // ========== ğŸ†• ì…ê³ ì§€ ì²˜ë¦¬ í•¨ìˆ˜ ==========
  function extractLocationsFromFiles() {
    const foundLocations = new Set();
    const locationKeys = Object.keys(locationData);
    
    individualFileMap.forEach(item => {
      const fileName = item.fileName || item.name || (item.file ? item.file.name : '');
      locationKeys.forEach(loc => {
        if (fileName.includes(loc)) {
          foundLocations.add(loc);
        }
      });
    });
    return [...foundLocations];
  }

  function getSelectedLocation() {
    const locations = extractLocationsFromFiles();
    return locations.length > 0 ? locations[0] : '';
  }

  function getBrandNamesForRecipient(companyName) {
    if (companyBrands[companyName] && companyBrands[companyName].length > 0) {
      return companyBrands[companyName].join(', ');
    }
    return '';
  }

  // ========== ìˆ˜ì‹ ì ê´€ë¦¬ ==========
  function renderRecipientList(names, query = '') {
    const container = document.getElementById('recipientList');
    container.innerHTML = '';
    const filtered = names.filter(n => n.toLowerCase().includes(query.toLowerCase()));
    
    filtered.forEach(name => {
      const wrapper = document.createElement('div');
      wrapper.className = 'checkbox-wrapper';
      
      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.value = name;
      cb.id = 'recipient_' + name;
      cb.checked = !!selectedRecipients.find(r => r.name === name);
      cb.onchange = () => toggleRecipientSelection(name, cb.checked);
      
      const label = document.createElement('label');
      label.textContent = name;
      label.htmlFor = cb.id;
      label.style.cursor = 'pointer';
      label.style.flex = '1';
      
      wrapper.append(cb, label);
      container.appendChild(wrapper);
    });
  }

  function toggleRecipientSelection(name, isSelected) {
    if (isSelected) {
      const exists = selectedRecipients.find(r => r.name === name);
      if (!exists) {
        const rec = companyData[name] || {};
        selectedRecipients.push({
          name,
          to: (rec.email || '').trim(),
          cc: (rec.cc || '').trim()
        });
      }
    } else {
      selectedRecipients = selectedRecipients.filter(r => r.name !== name);
    }
    renderSelectedRecipients();
  }

  function renderSelectedRecipients() {
    const container = document.getElementById('selectedRecipientsDisplay');
    container.innerHTML = '';
    selectedRecipients.forEach(r => {
      const tag = document.createElement('span');
      tag.className = 'recipient-tag';
      tag.textContent = r.name;
      tag.onclick = () => openRecipientEditModal(r);
      container.appendChild(tag);
    });
  }

  function openRecipientEditModal(recipient) {
    editingRecipient = recipient;
    document.getElementById('editRecipientName').value = recipient.name;
    document.getElementById('editRecipientTo').value = recipient.to || '';
    document.getElementById('editRecipientCc').value = recipient.cc || '';
    showModal('recipientEditModal');
  }

  function saveRecipientEdit() {
    if (!editingRecipient) return;
    editingRecipient.to = document.getElementById('editRecipientTo').value.trim();
    editingRecipient.cc = document.getElementById('editRecipientCc').value.trim();
    hideModal('recipientEditModal');
    editingRecipient = null;
  }

  // ========== íŒŒì¼ ê´€ë¦¬ ==========
  async function clearAllCommonFiles() {
    if (!await showConfirm('ê³µí†µ ì²¨ë¶€íŒŒì¼ì„ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    document.getElementById('commonFiles').value = '';
    commonDriveFiles = [];
    renderCommonFiles();
    showAlert('ê³µí†µ ì²¨ë¶€íŒŒì¼ì´ ëª¨ë‘ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
  }

  async function clearAllIndividualFiles() {
    if (!await showConfirm('ê°œë³„ ì²¨ë¶€íŒŒì¼ì„ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nìˆ˜ì‹ ì ì„ íƒë„ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.')) return;
    document.getElementById('individualFiles').value = '';
    individualFileMap = [];
    individualDriveFiles = [];
    renderIndividualFiles();
    syncSelectedRecipientsToMapping();
    showAlert('ê°œë³„ ì²¨ë¶€íŒŒì¼ì´ ëª¨ë‘ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
  }

  function handleCommonFilesChange() {
    renderCommonFiles();
  }

  async function handleIndividualFilesChange() {
    const files = [...document.getElementById('individualFiles').files];

    // âœ… ê°œì„ : íŒŒì¼ì„ ì¦‰ì‹œ Base64ë¡œ ë³€í™˜í•´ì„œ ì €ì¥
    for (const f of files) {
      const existing = individualFileMap.find(item =>
        (item.fileName === f.name) || (item.file && item.file.name === f.name)
      );

      if (!existing) {
        // ğŸ†• ë°ì´í„° ë¡œë”© ì™„ë£Œ ì—¬ë¶€ì— ë”°ë¼ ë§¤í•‘ ìˆ˜í–‰
        const mappedRecipients = isDataLoaded ? autoMapFile(f.name) : [];
        const details = isDataLoaded ? autoMapFileDetails(f.name) : [];

        // âœ… Base64ë¡œ ì¦‰ì‹œ ë³€í™˜
        const base64Data = await fileToBase64(f);

        individualFileMap.push({
          fileName: f.name,
          mimeType: f.type || getMimeTypeFromFileName(f.name),
          base64Data: base64Data,  // âœ… Base64 ë°ì´í„° ì €ì¥
          recipients: mappedRecipients,
          mappingDetails: details,
          type: 'local'
        });
      }
    }

    renderIndividualFiles();

    // ğŸ†• ë°ì´í„°ê°€ ë¡œë“œëœ ê²½ìš°ì—ë§Œ ìˆ˜ì‹ ì ë™ê¸°í™”
    if (isDataLoaded) {
      syncSelectedRecipientsToMapping();
    }
  }

  // âœ… ì¶”ê°€: íŒŒì¼ëª…ì—ì„œ mimeType ì¶”ë¡ í•˜ëŠ” í•¨ìˆ˜
  function getMimeTypeFromFileName(fileName) {
    const ext = fileName.toLowerCase().split('.').pop();
    const mimeTypes = {
      'txt': 'text/plain',
      'pdf': 'application/pdf',
      'doc': 'application/msword',
      'docx': 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
      'xls': 'application/vnd.ms-excel',
      'xlsx': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
      'ppt': 'application/vnd.ms-powerpoint',
      'pptx': 'application/vnd.openxmlformats-officedocument.presentationml.presentation',
      'jpg': 'image/jpeg',
      'jpeg': 'image/jpeg',
      'png': 'image/png',
      'gif': 'image/gif',
      'zip': 'application/zip',
      'rar': 'application/x-rar-compressed',
      '7z': 'application/x-7z-compressed'
    };
    
    return mimeTypes[ext] || 'application/octet-stream';
  }

  function preprocessString(str) {
    return str
      .replace(/\.[^/.]+$/, '')
      .replace(/ì£¼ì‹íšŒì‚¬|ãˆœ|\(ì£¼\)/g, '')
      .replace(/[\s\(\)\[\]_-]+/g, '')
      .replace(/\d{6}/g, '')
      .toLowerCase()
      .trim();
  }

  function autoMapFile(fileName) {
    const processedFileName = preprocessString(fileName);
    const recipients = new Set();

    companyNames.forEach(name => {
      const pName = preprocessString(name);
      
      if (processedFileName.includes(pName)) {
        recipients.add(name);
        return;
      }
      
      if (pName.length >= 3) {
        const short = pName.substring(0, Math.min(pName.length, 5));
        if (short.length >= 3 && processedFileName.includes(short)) {
          recipients.add(name);
        }
      }
    });

    Object.entries(companyBrands).forEach(([company, brands]) => {
      (brands || []).forEach(rawBrand => {
        const pBrand = preprocessString(rawBrand);
        if (!pBrand || pBrand.length < 2) return;
        
        if (processedFileName.includes(pBrand)) {
          recipients.add(company);
          return;
        }
        
        if (pBrand.length >= 3) {
          const short = pBrand.substring(0, Math.min(pBrand.length, 5));
          if (short.length >= 3 && processedFileName.includes(short)) {
            recipients.add(company);
          }
        }
      });
    });

    return [...recipients];
  }

  function autoMapFileDetails(fileName) {
    const processedFileName = preprocessString(fileName);
    const details = [];

    companyNames.forEach(name => {
      const pName = preprocessString(name);
      
      if (processedFileName.includes(pName)) {
        details.push({ name, type: 'official-strong' });
      } else if (pName.length >= 3) {
        const short = pName.substring(0, Math.min(pName.length, 5));
        if (short.length >= 3 && processedFileName.includes(short)) {
          details.push({ name, type: 'official-weak' });
        }
      }
    });

    Object.entries(companyBrands).forEach(([company, brands]) => {
      (brands || []).forEach(rawBrand => {
        const pBrand = preprocessString(rawBrand);
        if (!pBrand || pBrand.length < 2) return;
        
        if (processedFileName.includes(pBrand)) {
          details.push({ name: company, alias: rawBrand, type: 'brand-strong' });
        } else if (pBrand.length >= 3) {
          const short = pBrand.substring(0, Math.min(pBrand.length, 5));
          if (short.length >= 3 && processedFileName.includes(short)) {
            details.push({ name: company, alias: rawBrand, type: 'brand-weak' });
          }
        }
      });
    });

    return details;
  }

  function syncSelectedRecipientsToMapping() {
    const mapped = new Set();
    individualFileMap.forEach(item => {
      (item.recipients || []).forEach(n => mapped.add(n));
    });

    const newList = [];
    companyNames.forEach(name => {
      if (mapped.has(name)) {
        const rec = companyData[name] || {};
        newList.push({
          name,
          to: (rec.email || '').trim(),
          cc: (rec.cc || '').trim()
        });
      }
    });

    selectedRecipients = newList;
    renderSelectedRecipients();

    const modal = document.getElementById('recipientModal');
    if (modal && modal.style.display === 'flex') {
      renderRecipientList(companyNames);
    }
  }

  function renderCommonFiles() {
    const container = document.getElementById('commonFileList');
    container.innerHTML = '';
    
    const localFiles = [...document.getElementById('commonFiles').files];
    localFiles.forEach((f, idx) => {
      const item = createFileItem(f.name, 'LOCAL', () => {
        const dt = new DataTransfer();
        localFiles.forEach((file, i) => {
          if (i !== idx) dt.items.add(file);
        });
        document.getElementById('commonFiles').files = dt.files;
        renderCommonFiles();
      });
      container.appendChild(item);
    });

    commonDriveFiles.forEach((f, idx) => {
      const item = createFileItem(f.name, 'DRIVE', () => {
        commonDriveFiles.splice(idx, 1);
        renderCommonFiles();
      });
      container.appendChild(item);
    });
  }

  function renderIndividualFiles() {
    const container = document.getElementById('individualFileList');
    container.innerHTML = '';
    
    individualFileMap.forEach((item, idx) => {
      const badge = item.type === 'drive' ? 'DRIVE' : 'LOCAL';
      // âœ… ê°œì„ : item.fileName ë˜ëŠ” item.name ì‚¬ìš©
      const displayName = item.fileName || item.name || (item.file ? item.file.name : 'ì•Œ ìˆ˜ ì—†ìŒ');
      
      const fileItem = createFileItem(displayName, badge, () => {
        individualFileMap.splice(idx, 1);
        renderIndividualFiles();
        syncSelectedRecipientsToMapping();
      });
      container.appendChild(fileItem);
    });
  }

  function createFileItem(name, badge, onDelete) {
    const item = document.createElement('div');
    item.className = 'file-item';
    
    const left = document.createElement('div');
    left.className = 'file-item-left';
    
    const fileName = document.createElement('span');
    fileName.className = 'file-item-name';
    fileName.textContent = name;
    
    const badgeEl = document.createElement('span');
    badgeEl.className = 'file-badge';
    badgeEl.textContent = badge;
    
    left.append(fileName, badgeEl);
    
    const deleteBtn = document.createElement('button');
    deleteBtn.className = 'btn-icon';
    deleteBtn.innerHTML = 'Ã—';
    deleteBtn.onclick = onDelete;
    
    item.append(left, deleteBtn);
    return item;
  }

  // Part 3ì—ì„œ ê³„ì†...
// ========== ë¯¸ë¦¬ë³´ê¸° ==========
  async function showPreviewModal() {
    if (selectedRecipients.length === 0) {
      await showAlert('ìˆ˜ì‹ ìë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
      return;
    }

    const sel = document.getElementById('previewRecipientSelect');
    sel.innerHTML = '<option value="">ìˆ˜ì‹ ìë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
    
    selectedRecipients.forEach((r, idx) => {
      const opt = document.createElement('option');
      opt.value = idx;
      opt.textContent = `${r.name} (${r.to})`;
      sel.appendChild(opt);
    });

    sel.selectedIndex = 1;
    updatePreview();
    showModal('previewModal');
  }

  function updatePreview() {
    const sel = document.getElementById('previewRecipientSelect');
    const idx = parseInt(sel.value);

    if (isNaN(idx) || idx < 0 || idx >= selectedRecipients.length) {
      document.getElementById('previewSubject').textContent = 'ìˆ˜ì‹ ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”';
      document.getElementById('previewBody').innerHTML = '';
      return;
    }

    const recipient = selectedRecipients[idx];
    const subject = document.getElementById('mailSubject').value;
    let body = document.getElementById('mailBody').value;
    const signature = document.getElementById('mailSignature').value;
    const now = new Date();
  
    // âœ… ìˆ˜ì •: í˜„ì¬ ë¯¸ë¦¬ë³´ê¸° ì¤‘ì¸ ìˆ˜ì‹ ìì˜ ì²¨ë¶€íŒŒì¼ì—ì„œë§Œ ì…ê³ ì§€ ì¶”ì¶œ
    const recipientAttachments = [];
    individualFileMap.forEach(item => {
      if (item.recipients && item.recipients.includes(recipient.name)) {
        const fileName = item.fileName || item.name || (item.file ? item.file.name : '');
        if (fileName) {
          recipientAttachments.push(fileName);
        }
      }
    });
    
    // ì´ ìˆ˜ì‹ ìì˜ ì²¨ë¶€íŒŒì¼ì—ì„œë§Œ ì…ê³ ì§€ í‚¤ì›Œë“œ ì¶”ì¶œ
    const recipientLocationKeys = [];
    const allLocationKeys = Object.keys(locationData);
    
    recipientAttachments.forEach(fileName => {
      allLocationKeys.forEach(locKey => {
        if (fileName.includes(locKey) && !recipientLocationKeys.includes(locKey)) {
          recipientLocationKeys.push(locKey);
        }
      });
    });
  
    const allLocationDetails = recipientLocationKeys
      .map((loc, index) => {
        const detail = locationData[loc] || '';
        if (!detail) return '';
        const prefix = recipientLocationKeys.length > 1 ? `ì…ê³ ì§€${index + 1}.\n` : '';
        return prefix + detail;
      })
      .filter(Boolean)
      .join('\n\n');

    const locationNames = recipientLocationKeys.join(', ');

    const variables = {
      '{{ì—…ì²´ëª…}}': recipient.name,
      '{{ê±°ë˜ì²˜ëª…}}': recipient.name,
      '{{ë¸Œëœë“œëª…}}': getBrandNamesForRecipient(recipient.name),
      '{{ì´ë©”ì¼}}': recipient.to,
      '{{ì°¸ì¡°}}': recipient.cc || '',
      '{{ë°œì†¡ì¼}}': now.toISOString().split('T')[0],
      '{{ë‹´ë‹¹ìëª…}}': '',
      '{{ì…ê³ ì§€}}': allLocationDetails,
      '{{ì…ê³ ì§€ëª…}}': locationNames
    };

    // âœ… ì´ ìˆ˜ì‹ ìì—ê²Œ í•´ë‹¹í•˜ëŠ” ì…ê³ ì§€ í‚¤ì›Œë“œë§Œ ë³€ìˆ˜ë¡œ ì¶”ê°€
    recipientLocationKeys.forEach((loc) => {
      variables[`{{${loc}}}`] = loc;  // suffix ì œê±°
    });

    let previewSubject = subject;
    let previewBody = body;
    Object.keys(variables).forEach(key => {
      const regex = new RegExp(key.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
      previewSubject = previewSubject.replace(regex, variables[key]);
      previewBody = previewBody.replace(regex, variables[key]);
    });

    // âœ… ì¹˜í™˜ë˜ì§€ ì•Šì€ ì…ê³ ì§€ ë³€ìˆ˜ëŠ” ì œê±°
    allLocationKeys.forEach(locKey => {
      if (!recipientLocationKeys.includes(locKey)) {
        const regex = new RegExp(`\\{\\{\\s*${locKey}\\s*\\}\\}`, 'g');
        previewSubject = previewSubject.replace(regex, '');
        previewBody = previewBody.replace(regex, '');
      }
    });

    previewSubject = previewSubject.replace(/\{\{[^}]*\}\}/g, '');
    previewBody = previewBody.replace(/\{\{[^}]*\}\}/g, '');
    previewBody = previewBody.replace(/\n/g, '<br>');
  
    if (signature) {
      previewBody += '<br><br>' + signature.replace(/\n/g, '<br>');
    }

    document.getElementById('previewSubject').textContent = previewSubject;
    document.getElementById('previewBody').innerHTML = previewBody;
  
    const previewContainer = document.querySelector('.preview-container');
    const existingBadge = previewContainer.querySelector('.location-badge');
    if (existingBadge) existingBadge.remove();
  
    if (recipientLocationKeys.length > 0) {
      const badge = document.createElement('span');
      badge.className = 'location-badge';
      badge.textContent = `ğŸ“ ${recipientLocationKeys.join(', ')}`;
      document.getElementById('previewSubject').appendChild(badge);
    }
  }

  // ========== ë©”ì¼ ë°œì†¡ ==========
  async function startMailSending() {
    if (selectedRecipients.length === 0) {
      individualFileMap.forEach(item => {
        const name = item.fileName || item.name || (item.file ? item.file.name : '');
        autoMapFile(name);
      });
    }

    if (selectedRecipients.length === 0) {
      await showAlert('ìˆ˜ì‹ ìë¥¼ ì„ íƒí•˜ì„¸ìš”.', 'warning');
      return;
    }

    const validation = validateBeforeSend();

    // í•„ìˆ˜ ì˜¤ë¥˜ëŠ” ë°˜ë“œì‹œ ì°¨ë‹¨
    if (validation.errors.length > 0) {
      await showAlert('ë°œì†¡í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤:\n\n' + validation.errors.join('\n'), 'error', 'ë°œì†¡ ì˜¤ë¥˜');
      return;
    }

    // ì¤‘ë³µ ì´ë©”ì¼ ê²½ê³  (ë³„ë„ ê°•ì¡°)
    for (const warning of validation.warnings) {
      if (warning.type === 'duplicate') {
        if (!await showConfirm(warning.message + '\n\nì •ë§ ì¤‘ë³µ ë°œì†¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', 'error', 'ì¤‘ë³µ ì´ë©”ì¼ ê²½ê³ ')) {
          return;
        }
      }
    }

    // ğŸ†• ì…ê³ ì§€ ìë™ ê°ì§€
    const selectedLocation = getSelectedLocation();

    if (!selectedLocation) {
      if (!await showConfirm('ì…ê³ ì§€ê°€ ê°ì§€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\nê³„ì† ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', 'warning', 'ì…ê³ ì§€ ë¯¸ê°ì§€')) {
        return;
      }
    }

    const payload = await buildAttachmentsPayload();
    const sendBatchId = generateBatchId();

    const interval = (parseInt(document.getElementById('sendInterval').value) || 2) * 1000;
    initProgress(selectedRecipients.length);
    showModal('progressModal');

    let i = 0;
    const tick = () => {
      if (i >= selectedRecipients.length) {
        addLog('info', 'ëª¨ë“  ë©”ì¼ ë°œì†¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
        if (failedCount > 0) {
          addLog('info', 'ì‹¤íŒ¨ ' + failedCount + 'ê±´ ë°œìƒ. [ì‹¤íŒ¨ ë©”ì¼ ê´€ë¦¬]ì—ì„œ ì¬ë°œì†¡ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
        }
        loadFailedEmails();
        loadQuota();
        return;
      }

      const r = selectedRecipients[i];
      let base = buildMailData(r);

      const recipientAttachments = [];
      individualFileMap.forEach(item => {
        if (item.recipients && item.recipients.includes(r.name)) {
          const fileName = item.fileName || item.name || (item.file ? item.file.name : '');
          if (fileName) {
            recipientAttachments.push(fileName);
          }
        }
      });

      const recipientLocationKeys = [];
      const locationKeys = Object.keys(locationData);
      recipientAttachments.forEach(fileName => {
        locationKeys.forEach(locKey => {
          if (fileName.includes(locKey) && !recipientLocationKeys.includes(locKey)) {
            recipientLocationKeys.push(locKey);
          }
        });
      });

      base.selectedLocationKeys = recipientLocationKeys;
      base.attachments       = payload.attachments;
      base.commonAttachments = payload.commonAttachments;
      base.driveAttachments  = payload.driveAttachments;
      base.batchId = sendBatchId;
      base.retryCount = 0;

      const sel = document.getElementById('templateSelect');
      base.mailType = sel && sel.value ? sel.value : '';

      google.script.run
        .withSuccessHandler((result) => {
          if (result && result.status === 'success') {
            updateProgress('success', r.name, r.to);
          } else {
            updateProgress('failed', r.name, r.to, result ? result.message : '');
          }
          todaySentCount++;
          updateQuotaDisplay();
          i++;
          setTimeout(tick, interval);
        })
        .withFailureHandler((error) => {
          updateProgress('failed', r.name, r.to, error.message);
          i++;
          setTimeout(tick, interval);
        })
        .sendSingleMail(base, r);
    };

    tick();
  } 

  function validateBeforeSend() {
    const errors = [];
    const warnings = [];
    const subj = document.getElementById('mailSubject').value.trim();
    const body = document.getElementById('mailBody').value.trim();

    if (!subj) errors.push('- ë©”ì¼ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.');
    if (!body) errors.push('- ë©”ì¼ ë³¸ë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”.');

    const emptyTo = selectedRecipients.filter(r => !r.to || !isValidEmail(r.to));
    if (emptyTo.length > 0) {
      errors.push(`- ë‹¤ìŒ ìˆ˜ì‹ ìì˜ ì´ë©”ì¼ì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤: ${emptyTo.map(r => r.name).join(', ')}`);
    }

    // ì¤‘ë³µ ì´ë©”ì¼ ìƒì„¸ ê²€ì‚¬
    const emailMap = {};
    selectedRecipients.forEach(r => {
      if (r.to) {
        if (!emailMap[r.to]) emailMap[r.to] = [];
        emailMap[r.to].push(r.name);
      }
    });

    const duplicateDetails = [];
    Object.keys(emailMap).forEach(email => {
      if (emailMap[email].length > 1) {
        duplicateDetails.push(`  â€¢ ${email}: ${emailMap[email].join(', ')}`);
      }
    });

    if (duplicateDetails.length > 0) {
      warnings.push({
        type: 'duplicate',
        message: `ì¤‘ë³µëœ ì´ë©”ì¼ ì£¼ì†Œê°€ ìˆìŠµë‹ˆë‹¤:\n${duplicateDetails.join('\n')}\n\nê°™ì€ ì£¼ì†Œë¡œ ${duplicateDetails.length}ê±´ì˜ ë©”ì¼ì´ ì¤‘ë³µ ë°œì†¡ë©ë‹ˆë‹¤.`
      });
    }

    return { errors, warnings };
  }

  function isValidEmail(email) {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
  }

function buildMailData(recipient) {
    let subject = document.getElementById('mailSubject').value;
    let body    = document.getElementById('mailBody').value;
    const signature = document.getElementById('mailSignature').value;

    const now = new Date();
  
    // âœ… ê°œì„ : fileName ì‚¬ìš©
    const recipientAttachments = [];
    individualFileMap.forEach(item => {
      if (item.recipients && item.recipients.includes(recipient.name)) {
        const fileName = item.fileName || item.name || (item.file ? item.file.name : '');
        if (fileName) {
          recipientAttachments.push(fileName);
        }
      }
    });
    
    const recipientLocationKeys = [];
    const allLocationKeys = Object.keys(locationData);
    
    recipientAttachments.forEach(fileName => {
      allLocationKeys.forEach(locKey => {
        if (fileName.includes(locKey) && !recipientLocationKeys.includes(locKey)) {
          recipientLocationKeys.push(locKey);
        }
      });
    });

    const allLocationDetails = recipientLocationKeys
      .map((loc, index) => {
        const detail = locationData[loc] || '';
        if (!detail) return '';
    
        if (recipientLocationKeys.length > 1) {
          return 'ì…ê³ ì§€' + (index + 1) + '.\n' + detail;
        }
        return detail;
      })
      .filter(Boolean)
      .join('\n\n');

    const allContacts = recipientLocationKeys.map(loc => contactData[loc] || '').filter(Boolean).join(', ');
    const allPhones = recipientLocationKeys.map(loc => phoneData[loc] || '').filter(Boolean).join(', ');

    const locationNames = recipientLocationKeys.join(', ');

    const variables = {
      '{{ì—…ì²´ëª…}}': recipient.name,
      '{{ê±°ë˜ì²˜ëª…}}': recipient.name,
      '{{ë¸Œëœë“œëª…}}': getBrandNamesForRecipient(recipient.name),
      '{{ì´ë©”ì¼}}': recipient.to,
      '{{ì°¸ì¡°}}': recipient.cc || '',
      '{{ë°œì†¡ì¼}}': now.toISOString().split('T')[0],
      '{{ë‹´ë‹¹ìëª…}}': '',
      '{{ì…ê³ ì§€}}': allLocationDetails,
      '{{ì…ê³ ì§€ëª…}}': locationNames 
    };

    recipientLocationKeys.forEach((loc) => {
      variables[`{{${loc}}}`] = loc;  // suffix ì œê±°
    });

    Object.keys(variables).forEach(key => {
      const inner = key.replace(/^\{\{|\}\}$/g, '').trim();
      const regex = new RegExp(`\\{\\{\\s*${inner}\\s*\\}\\}`, 'g');
      subject = subject.replace(regex, variables[key]);
      body    = body.replace(regex, variables[key]);
    });

    allLocationKeys.forEach(locKey => {
      if (!recipientLocationKeys.includes(locKey)) {
        const regex = new RegExp(`\\{\\{\\s*${locKey}\\s*\\}\\}`, 'g');
        subject = subject.replace(regex, '');
        body = body.replace(regex, '');
      }
    });

    subject = subject.replace(/\{\{[^}]*\}\}/g, '');
    body = body.replace(/\{\{[^}]*\}\}/g, '');
  
    let finalBody = body;
    if (signature) {
      finalBody += '\n\n' + signature;
    }

    return { subject, body: finalBody };
  }

  async function buildAttachmentsPayload() {
    const commonFiles = [...document.getElementById('commonFiles').files];
    const commonAttachments = await Promise.all(commonFiles.map(async f => {
      let mimeType = f.type || getMimeTypeFromFileName(f.name);
      
      return {
        fileName: f.name,
        mimeType: mimeType,
        data: await fileToBase64(f)
      };
    }));

    // âœ… ê°œì„ : individualFileMapì— ì´ë¯¸ ì €ì¥ëœ Base64 ë°ì´í„° ì‚¬ìš©
    const localIndividual = individualFileMap.filter(it => it.type === 'local');
    const attachments = localIndividual.map(item => ({
      fileName: item.fileName,
      mimeType: item.mimeType,
      data: item.base64Data,  // âœ… ì´ë¯¸ ë³€í™˜ëœ Base64 ë°ì´í„° ì‚¬ìš©!
      mappedRecipients: [...new Set(item.recipients)]
    }));

    const driveIndividual = individualFileMap.filter(it => it.type === 'drive');
    const driveAttachments = [
      ...commonDriveFiles.map(f => ({ id: f.id, name: f.name, mappedRecipients: null })),
      ...driveIndividual.map(f => ({ id: f.id, name: f.name, mappedRecipients: f.recipients }))
    ];

    return { attachments, commonAttachments, driveAttachments };
  }

  function fileToBase64(file) {
    return new Promise((resolve, reject) => {
      const r = new FileReader();
      r.onload = () => { resolve(String(r.result).split(',')[1] || ''); };
      r.onerror = reject;
      r.readAsDataURL(file);
    });
  }

  // ========== ì§„í–‰ ìƒí™© ==========
  let totalCount = 0, successCount = 0, failedCount = 0;

  function initProgress(total) {
    totalCount = total;
    successCount = 0;
    failedCount = 0;
    document.getElementById('progressSummary').textContent = `ì´ ${totalCount}ê±´ ë°œì†¡ ì¤‘...`;
    document.getElementById('progressLog').innerHTML = '';
    updateStats();
  }

  function updateProgress(status, name, to, errorMsg = '') {
    if (status === 'success') successCount++;
    else failedCount++;
    
    document.getElementById('progressSummary').textContent = 
      `ì´ ${totalCount}ê±´ ì¤‘ ${successCount} ì„±ê³µ, ${failedCount} ì‹¤íŒ¨`;
    
    const msg = errorMsg ? ` (${errorMsg})` : '';
    addLog(status, `${name} (${to})${msg}`);
    updateStats();
  }

  function addLog(type, message) {
    const log = document.getElementById('progressLog');
    const line = document.createElement('div');
    line.className = 'log-line log-' + type;
    line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
    log.appendChild(line);
    log.scrollTop = log.scrollHeight;
  }

  function updateStats() {
    document.getElementById('statTotal').textContent = totalCount;
    document.getElementById('statSuccess').textContent = successCount;
    document.getElementById('statFailed').textContent = failedCount;
  }

  function calculateTodaySent() {
    google.script.run
      .withSuccessHandler(count => {
        todaySentCount = count || 0;
        updateQuotaDisplay();
      })
      .getTodaySentCount();
  }

  function updateQuotaDisplay() {
    document.getElementById('todaySent').textContent = todaySentCount;
    if (quotaRemainingCount !== null) {
      document.getElementById('quotaRemaining').textContent = quotaRemainingCount;
    }
  }

  function loadQuota() {
    google.script.run
      .withSuccessHandler((result) => {
        quotaRemainingCount = result.remaining;
        updateQuotaDisplay();
      })
      .withFailureHandler(() => {
        document.getElementById('quotaRemaining').textContent = '-';
      })
      .getAccountQuota();
  }

  // ========== í…œí”Œë¦¿ ê´€ë¦¬ ==========
  function renderTemplateList() {
    const container = document.getElementById('templateList');
    container.innerHTML = '';

    Object.keys(mailTemplates).forEach(name => {
      const item = document.createElement('div');
      item.className = 'template-item';

      const nameEl = document.createElement('div');
      nameEl.textContent = name;
      nameEl.style.fontWeight = '500';

      const actions = document.createElement('div');
      actions.className = 'template-item-actions';

      const editBtn = document.createElement('button');
      editBtn.className = 'btn-secondary btn-compact';
      editBtn.textContent = 'ìˆ˜ì •';
      editBtn.onclick = (e) => {
        e.stopPropagation();
        editTemplate(name);
      };

      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'btn-danger btn-compact';
      deleteBtn.textContent = 'ì‚­ì œ';
      deleteBtn.onclick = async (e) => {
        e.stopPropagation();
        if (await showConfirm(`"${name}" í…œí”Œë¦¿ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
          deleteTemplate(name);
        }
      };

      actions.append(editBtn, deleteBtn);
      item.append(nameEl, actions);
      container.appendChild(item);
    });
  }

  function editTemplate(name) {
    editingTemplate = name;
    const template = mailTemplates[name];
    document.getElementById('templateEditTitle').textContent = 'í…œí”Œë¦¿ ìˆ˜ì •';
    document.getElementById('editTemplateName').value = name;
    document.getElementById('editTemplateName').disabled = true;
    document.getElementById('editTemplateSubject').value = template.subject || '';
    document.getElementById('editTemplateBody').value = template.body || '';
    document.getElementById('editTemplateSignature').value = template.signature || '';
    showModal('templateEditModal');
  }

  async function saveTemplate() {
    const name = document.getElementById('editTemplateName').value.trim();
    const subject = document.getElementById('editTemplateSubject').value.trim();
    const body = document.getElementById('editTemplateBody').value.trim();
    const signature = document.getElementById('editTemplateSignature').value.trim();

    if (!name) {
      await showAlert('í…œí”Œë¦¿ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.', 'warning');
      return;
    }

    const templateData = { name, subject, body, signature };

    google.script.run
      .withSuccessHandler(() => {
        mailTemplates[name] = { subject, body, signature };
        initTemplateSelect();
        renderTemplateList();
        hideModal('templateEditModal');
        showAlert('í…œí”Œë¦¿ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
      })
      .withFailureHandler((error) => {
        showAlert('ì €ì¥ ì‹¤íŒ¨: ' + error.message, 'error');
      })
      .saveMailTemplate(templateData);
  }

  function deleteTemplate(name) {
    google.script.run
      .withSuccessHandler(() => {
        delete mailTemplates[name];
        initTemplateSelect();
        renderTemplateList();
        showAlert('í…œí”Œë¦¿ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
      })
      .withFailureHandler((error) => {
        showAlert('ì‚­ì œ ì‹¤íŒ¨: ' + error.message, 'error');
      })
      .deleteMailTemplate(name);
  }

  // ========== ê·¸ë£¹ ê´€ë¦¬ ==========
  function renderGroupList() {
    const container = document.getElementById('groupList');
    container.innerHTML = '';

    Object.keys(groups).forEach(groupName => {
      const item = document.createElement('div');
      item.className = 'group-item';

      const header = document.createElement('div');
      header.className = 'group-item-header';

      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.onchange = () => {
        if (cb.checked) {
          selectGroup(groupName);
        } else {
          deselectGroup(groupName);
        }
      };

      const nameEl = document.createElement('div');
      nameEl.className = 'group-item-name';
      nameEl.textContent = groupName;

      const count = document.createElement('div');
      count.className = 'group-item-count';
      count.textContent = `${groups[groupName].length}ê°œ ì—…ì²´`;

      header.append(cb, nameEl, count);

      const companiesList = document.createElement('div');
      companiesList.className = 'group-item-companies';
      companiesList.textContent = groups[groupName].join(', ');

      item.append(header, companiesList);
      container.appendChild(item);
    });

    renderExistingGroups();
  }

  function renderExistingGroups() {
    const container = document.getElementById('existingGroups');
    container.innerHTML = '';

    Object.keys(groups).forEach(groupName => {
      const item = document.createElement('div');
      item.style.display = 'flex';
      item.style.justifyContent = 'space-between';
      item.style.alignItems = 'center';
      item.style.padding = '12px';
      item.style.background = 'var(--bg-secondary)';
      item.style.borderRadius = '8px';
      item.style.marginBottom = '8px';

      const nameEl = document.createElement('div');
      nameEl.textContent = `${groupName} (${groups[groupName].length}ê°œ)`;

      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'btn-danger btn-compact';
      deleteBtn.textContent = 'ì‚­ì œ';
      deleteBtn.onclick = async () => {
        if (await showConfirm(`"${groupName}" ê·¸ë£¹ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
          deleteGroup(groupName);
        }
      };

      item.append(nameEl, deleteBtn);
      container.appendChild(item);
    });
  }

  function selectGroup(groupName) {
    const companies = groups[groupName] || [];
    companies.forEach(name => {
      if (!selectedRecipients.find(r => r.name === name)) {
        const rec = companyData[name] || {};
        selectedRecipients.push({
          name,
          to: (rec.email || '').trim(),
          cc: (rec.cc || '').trim()
        });
      }
    });
    renderSelectedRecipients();
    renderRecipientList(companyNames);
  }

  function deselectGroup(groupName) {
    const companies = groups[groupName] || [];
    selectedRecipients = selectedRecipients.filter(r => !companies.includes(r.name));
    renderSelectedRecipients();
    renderRecipientList(companyNames);
  }

  async function createGroup() {
    const groupName = document.getElementById('newGroupName').value.trim();
    if (!groupName) {
      await showAlert('ê·¸ë£¹ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.', 'warning');
      return;
    }

    if (groups[groupName]) {
      await showAlert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ê·¸ë£¹ëª…ì…ë‹ˆë‹¤.', 'warning');
      return;
    }

    const companies = selectedRecipients.map(r => r.name);
    if (companies.length === 0) {
      await showAlert('ì„ íƒëœ ìˆ˜ì‹ ìê°€ ì—†ìŠµë‹ˆë‹¤.', 'warning');
      return;
    }

    google.script.run
      .withSuccessHandler(() => {
        groups[groupName] = companies;
        document.getElementById('newGroupName').value = '';
        renderGroupList();
        showAlert('ê·¸ë£¹ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
      })
      .withFailureHandler((error) => {
        showAlert('ê·¸ë£¹ ìƒì„± ì‹¤íŒ¨: ' + error.message, 'error');
      })
      .saveGroup(groupName, companies);
  }

  function deleteGroup(groupName) {
    google.script.run
      .withSuccessHandler(() => {
        delete groups[groupName];
        renderGroupList();
        showAlert('ê·¸ë£¹ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
      })
      .withFailureHandler((error) => {
        showAlert('ê·¸ë£¹ ì‚­ì œ ì‹¤íŒ¨: ' + error.message, 'error');
      })
      .deleteGroup(groupName);
  }

  // íŒŒì¼ ë§¤í•‘ ê´€ë¦¬ëŠ” ë‹¤ìŒ ë©”ì‹œì§€ì—ì„œ ê³„ì†...
// ========== íŒŒì¼ ë§¤í•‘ ê´€ë¦¬ ==========
  function renderFileMapping() {
    const container = document.getElementById('fileMappingContainer');
    container.innerHTML = '';
    
    if (individualFileMap.length === 0) {
      container.innerHTML = '<div style="color: var(--text-secondary); text-align: center; padding: 40px;">ê°œë³„ ì²¨ë¶€íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
      return;
    }

    const totalFiles = individualFileMap.length;
    const successFiles = individualFileMap.filter(item => item.recipients && item.recipients.length === 1).length;
    const failedFiles = individualFileMap.filter(item => !item.recipients || item.recipients.length === 0).length;
    const duplicateFiles = individualFileMap.filter(item => item.recipients && item.recipients.length > 1).length;

    const statsDiv = document.createElement('div');
    statsDiv.style.display = 'grid';
    statsDiv.style.gridTemplateColumns = 'repeat(4, 1fr)';
    statsDiv.style.gap = '12px';
    statsDiv.style.marginBottom = '20px';
    statsDiv.style.padding = '16px';
    statsDiv.style.background = 'var(--bg-secondary)';
    statsDiv.style.borderRadius = '8px';

    const createStatItem = (label, value, color) => {
      const item = document.createElement('div');
      item.style.textAlign = 'center';
      item.innerHTML = `
        <div style="font-size: 24px; font-weight: 700; color: ${color};">${value}</div>
        <div style="font-size: 13px; color: var(--text-secondary); margin-top: 4px;">${label}</div>
      `;
      return item;
    };

    statsDiv.appendChild(createStatItem('ì²¨ë¶€íŒŒì¼', totalFiles, 'var(--text-primary)'));
    statsDiv.appendChild(createStatItem('ë§¤í•‘ì™„ë£Œ', successFiles, 'var(--success)'));
    statsDiv.appendChild(createStatItem('ì¤‘ë³µë§¤í•‘', duplicateFiles, 'var(--warning)'));
    statsDiv.appendChild(createStatItem('ë§¤í•‘ì‹¤íŒ¨', failedFiles, 'var(--danger)'));

    container.appendChild(statsDiv);

    const sortedFiles = [...individualFileMap].sort((a, b) => {
      const aCount = (a.recipients || []).length;
      const bCount = (b.recipients || []).length;
      
      if (aCount === 0 && bCount !== 0) return -1;
      if (aCount !== 0 && bCount === 0) return 1;
      
      if (aCount > 1 && bCount <= 1) return -1;
      if (aCount <= 1 && bCount > 1) return 1;
      
      return 0;
    });

    sortedFiles.forEach((item, index) => {
      const realIndex = individualFileMap.indexOf(item);
      const card = document.createElement('div');
      card.style.border = '1px solid var(--border)';
      card.style.borderRadius = '8px';
      card.style.padding = '16px';
      card.style.marginBottom = '16px';
      card.style.background = 'var(--bg-primary)';

      const recipientCount = (item.recipients || []).length;
      if (recipientCount === 0) {
        card.style.borderLeft = '4px solid var(--danger)';
      } else if (recipientCount > 1) {
        card.style.borderLeft = '4px solid var(--warning)';
      } else {
        card.style.borderLeft = '4px solid var(--success)';
      }

      const header = document.createElement('div');
      header.style.display = 'flex';
      header.style.justifyContent = 'space-between';
      header.style.alignItems = 'center';
      header.style.marginBottom = '12px';

      const titleDiv = document.createElement('div');
      titleDiv.style.display = 'flex';
      titleDiv.style.flexDirection = 'column';
      titleDiv.style.gap = '4px';

      const title = document.createElement('div');
      title.style.fontWeight = '600';
      title.textContent = item.fileName || item.name || (item.file ? item.file.name : 'ì•Œ ìˆ˜ ì—†ìŒ');

      const statusBadge = document.createElement('span');
      statusBadge.style.fontSize = '12px';
      statusBadge.style.padding = '2px 8px';
      statusBadge.style.borderRadius = '4px';
      statusBadge.style.fontWeight = '500';
      statusBadge.style.display = 'inline-block';
      statusBadge.style.width = 'fit-content';

      if (recipientCount === 0) {
        statusBadge.textContent = 'ë§¤í•‘ì‹¤íŒ¨';
        statusBadge.style.background = 'rgba(239, 68, 68, 0.1)';
        statusBadge.style.color = 'var(--danger)';
      } else if (recipientCount === 1) {
        statusBadge.textContent = 'ë§¤í•‘ì™„ë£Œ';
        statusBadge.style.background = 'rgba(16, 185, 129, 0.1)';
        statusBadge.style.color = 'var(--success)';
      } else {
        statusBadge.textContent = `ì¤‘ë³µë§¤í•‘ (${recipientCount}ê°œ)`;
        statusBadge.style.background = 'rgba(245, 158, 11, 0.1)';
        statusBadge.style.color = 'var(--warning)';
      }

      titleDiv.append(title, statusBadge);

      const actions = document.createElement('div');
      actions.style.display = 'flex';
      actions.style.gap = '8px';

      const btnAll = document.createElement('button');
      btnAll.className = 'btn-secondary btn-compact';
      btnAll.textContent = 'ì „ì²´ì„ íƒ';
      btnAll.onclick = () => {
        item.recipients = [...companyNames];
        renderFileMapping();
        syncSelectedRecipientsToMapping();
      };

      const btnNone = document.createElement('button');
      btnNone.className = 'btn-secondary btn-compact';
      btnNone.textContent = 'ì „ì²´í•´ì œ';
      btnNone.onclick = () => {
        item.recipients = [];
        renderFileMapping();
        syncSelectedRecipientsToMapping();
      };

      actions.append(btnAll, btnNone);

      header.append(titleDiv, actions);

      const list = document.createElement('div');
      list.style.maxHeight = '200px';
      list.style.overflowY = 'auto';
      list.style.border = '1px solid var(--border)';
      list.style.borderRadius = '8px';
      list.style.padding = '8px';

      const selectedSet = new Set(item.recipients || []);
      const sortedCompanies = [...companyNames].sort((a, b) => {
        const aChecked = selectedSet.has(a) ? 1 : 0;
        const bChecked = selectedSet.has(b) ? 1 : 0;
        if (aChecked !== bChecked) return bChecked - aChecked;
        return a.localeCompare(b, 'ko');
      });

      sortedCompanies.forEach(name => {
        const wrapper = document.createElement('div');
        wrapper.className = 'checkbox-wrapper';
        wrapper.style.padding = '6px 8px';

        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.checked = selectedSet.has(name);
        cb.onchange = () => {
          if (cb.checked) {
            if (!item.recipients.includes(name)) {
              item.recipients.push(name);
            }
          } else {
            item.recipients = item.recipients.filter(n => n !== name);
          }
          syncSelectedRecipientsToMapping();
          renderFileMapping();
        };

        const label = document.createElement('label');
        label.textContent = name;
        label.style.cursor = 'pointer';

        wrapper.append(cb, label);
        list.appendChild(wrapper);
      });

      card.append(header, list);
      container.appendChild(card);
    });
  }

  // ========== Google Drive Picker ==========
  function loadPickerApi() {
    gapi.load('picker', () => {
      pickerApiLoaded = true;
    });
  }

  async function pickDriveFiles(type) {
    if (!pickerApiLoaded || !oauthToken) {
      await showAlert('Drive Pickerë¥¼ ë¡œë“œ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'info');
      return;
    }

    const picker = new google.picker.PickerBuilder()
      .addView(google.picker.ViewId.DOCS)
      .setOAuthToken(oauthToken)
      .setCallback((data) => {
        if (data.action === google.picker.Action.PICKED) {
          data.docs.forEach(doc => {
            const fileData = {
              id: doc.id,
              name: doc.name,
              type: 'drive'
            };
            
            if (type === 'common') {
              if (!commonDriveFiles.find(f => f.id === doc.id)) {
                commonDriveFiles.push(fileData);
              }
              renderCommonFiles();
            } else {
              if (!individualFileMap.find(f => f.id === doc.id)) {
                const mappedRecipients = autoMapFile(doc.name);
                const details = autoMapFileDetails(doc.name);
                individualFileMap.push({
                  ...fileData,
                  recipients: mappedRecipients,
                  mappingDetails: details
                });
              }
              renderIndividualFiles();
              syncSelectedRecipientsToMapping();
            }
          });
        }
      })
      .build();
    picker.setVisible(true);
  }

  // ========== ì‹¤íŒ¨ ë©”ì¼ ê´€ë¦¬ ==========
  let currentBatchId = '';
  let failedMailData = [];

  function generateBatchId() {
    const now = new Date();
    return now.getFullYear().toString() +
      String(now.getMonth() + 1).padStart(2, '0') +
      String(now.getDate()).padStart(2, '0') + '_' +
      String(now.getHours()).padStart(2, '0') +
      String(now.getMinutes()).padStart(2, '0') +
      String(now.getSeconds()).padStart(2, '0') +
      String(now.getMilliseconds()).padStart(3, '0');
  }

  function loadFailedEmails() {
    google.script.run
      .withSuccessHandler((list) => {
        failedMailData = list || [];
        if (failedMailData.length > 0) {
          document.getElementById('failedMailCard').style.display = 'block';
          renderFailedEmails();
        } else {
          document.getElementById('failedMailCard').style.display = 'none';
        }
      })
      .withFailureHandler((err) => {
        console.log('ì‹¤íŒ¨ ë©”ì¼ ì¡°íšŒ ì˜¤ë¥˜:', err.message);
      })
      .getFailedEmails();
  }

  function renderFailedEmails() {
    const container = document.getElementById('failedMailList');
    container.innerHTML = '';

    const statsDiv = document.getElementById('failedMailStats');
    const totalFailed = failedMailData.filter(f => f.status === 'failed').length;
    const draftFailed = failedMailData.filter(f => f.status === 'failed_draft').length;
    statsDiv.innerHTML =
      '<span style="font-size:14px;color:var(--text-secondary);">' +
      'ì™„ì „ì‹¤íŒ¨: <strong style="color:var(--danger);">' + totalFailed + '</strong>' +
      ' | Draftì €ì¥: <strong style="color:var(--warning);">' + draftFailed + '</strong>' +
      ' | ì´: <strong>' + failedMailData.length + '</strong></span>';

    failedMailData.forEach((item) => {
      const line = document.createElement('div');
      line.className = 'log-line';
      const statusColor = item.status === 'failed' ? 'var(--danger)' : 'var(--warning)';
      const statusText = item.status === 'failed' ? 'ì‹¤íŒ¨' : 'Draft';
      const retryText = item.retryCount > 0 ? ' (ì¬ì‹œë„ ' + item.retryCount + 'íšŒ)' : '';
      line.innerHTML =
        '<span style="color:' + statusColor + ';">[' + statusText + ']</span> ' +
        item.name + ' (' + item.to + ')' + retryText +
        ' - <span style="font-size:12px;color:var(--text-secondary);">' + item.message + '</span>';
      container.appendChild(line);
    });
  }

  async function resendAllFailed() {
    if (failedMailData.length === 0) {
      await showAlert('ì¬ë°œì†¡í•  ì‹¤íŒ¨ ë©”ì¼ì´ ì—†ìŠµë‹ˆë‹¤.', 'info');
      return;
    }

    const subject = document.getElementById('mailSubject').value.trim();
    const body = document.getElementById('mailBody').value.trim();

    if (!subject || !body) {
      await showAlert('ì¬ë°œì†¡í•˜ë ¤ë©´ ë©”ì¼ ì œëª©ê³¼ ë³¸ë¬¸ì´ ì…ë ¥ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.\ní˜„ì¬ í™”ë©´ì˜ ë©”ì¼ ë‚´ìš©ìœ¼ë¡œ ì¬ë°œì†¡ë©ë‹ˆë‹¤.', 'warning');
      return;
    }

    if (!await showConfirm('ì‹¤íŒ¨í•œ ' + failedMailData.length + 'ê±´ì„ í˜„ì¬ ë©”ì¼ ë‚´ìš©ìœ¼ë¡œ ì¬ë°œì†¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', 'info', 'ì¬ë°œì†¡ í™•ì¸')) return;

    const payload = await buildAttachmentsPayload();
    const resendBatchId = generateBatchId();

    initProgress(failedMailData.length);
    showModal('progressModal');

    let i = 0;
    const resendInterval = 3000;

    const resendTick = () => {
      if (i >= failedMailData.length) {
        addLog('info', 'ì¬ë°œì†¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
        loadFailedEmails();
        loadQuota();
        return;
      }

      const item = failedMailData[i];
      const recipientData = { name: item.name, to: item.to, cc: '' };

      if (companyData[item.name]) {
        recipientData.cc = companyData[item.name].cc || '';
      }

      let base = buildMailData(recipientData);

      const recipientAttachments = [];
      individualFileMap.forEach(mapItem => {
        if (mapItem.recipients && mapItem.recipients.includes(item.name)) {
          const fileName = mapItem.fileName || mapItem.name || '';
          if (fileName) recipientAttachments.push(fileName);
        }
      });

      const recipientLocationKeys = [];
      const locationKeys = Object.keys(locationData);
      recipientAttachments.forEach(fileName => {
        locationKeys.forEach(locKey => {
          if (fileName.includes(locKey) && !recipientLocationKeys.includes(locKey)) {
            recipientLocationKeys.push(locKey);
          }
        });
      });

      base.selectedLocationKeys = recipientLocationKeys;
      base.attachments = payload.attachments;
      base.commonAttachments = payload.commonAttachments;
      base.driveAttachments = payload.driveAttachments;
      base.batchId = resendBatchId;
      base.retryCount = (item.retryCount || 0) + 1;

      const sel = document.getElementById('templateSelect');
      base.mailType = item.mailType || (sel && sel.value ? sel.value : '');

      google.script.run
        .withSuccessHandler((result) => {
          if (result && result.status === 'success') {
            updateProgress('success', item.name, item.to);
            todaySentCount++;
            updateQuotaDisplay();
          } else {
            updateProgress('failed', item.name, item.to, result ? result.message : '');
          }
          i++;
          setTimeout(resendTick, resendInterval);
        })
        .withFailureHandler((error) => {
          updateProgress('failed', item.name, item.to, error.message);
          i++;
          setTimeout(resendTick, resendInterval);
        })
        .sendSingleMail(base, recipientData);
    };

    resendTick();
  }

  // ========== ëª¨ë‹¬ ê´€ë¦¬ ==========
  function showModal(id) {
    document.getElementById(id).style.display = 'flex';
  }

  function hideModal(id) {
    document.getElementById(id).style.display = 'none';
  }
</script>

</body>
</html>
